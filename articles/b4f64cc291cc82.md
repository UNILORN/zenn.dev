---
title: "Socketé€šä¿¡ã¯APIGateway+Lambda+DynamoDBã«ä»»ã›ã‚ˆã†ï¼ˆ1ï¼‰"
emoji: "ğŸ’¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "apigateway", "lambda", "DynamoDB", "terraform"]
published: true
---

çš†ã•ã‚“ã¯Socketé€šä¿¡ã‚’åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹ã€‚
ç§ã¯çµæ§‹ãªé »åº¦ã§ä½¿ã£ã¦ã„ã¾ã™ã€‚

ä¾‹ãˆã°ã€å¤–éƒ¨ã«å…¬é–‹ã—ã¦ã„ãªã„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…éƒ¨ã®ç«¯æœ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¸ã„ä¸Šã’ãŸã„æ™‚çš†ã•ã‚“ã¯ã©ã†ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ

VPNã‚’å¼µã£ãŸã‚Š..? 

ã“ã†ã„ã£ãŸã‚±ãƒ¼ã‚¹ã§ã¯Socketé€šä¿¡ã‚’ã™ã‚‹ã¨æ¯”è¼ƒçš„ç°¡å˜ã«å®Ÿè£…ã§ãã¾ã™ã€‚

https://tech-blog.optim.co.jp/entry/2022/05/30/100000

ç§ãŒåŸ·ç­†ã—ãŸè¨˜äº‹ã§ã™ãŒã€ã“ã®æŠ€è¡“ã‚‚Socketé€šä¿¡ã‚’å¿œç”¨ã—ã¦ã„ã¾ã™ã€‚

## WebSocketã‚„HTTP Keep-Alive,Persistentã‚’åˆ©ç”¨ã—ãŸæ‡¸å¿µç‚¹

https://tex2e.github.io/rfc-translater/html/rfc7540.html

> 9.1. Connection Management
> 
> HTTP/2 connections are persistent. 

ã“ã®ã‚ãŸã‚Šã‚’è¦‹ã¦ã‚‚ã€æ¥ç¶šç®¡ç†ã«éå¸¸ã«è‹¦åŠ´ã™ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

ã‚¤ãƒ³ãƒ•ãƒ©ã®æ§‹æˆã¨ã—ã¦ã€WAFãŸALBã€ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ï¼ˆEnvoyã‚„istioï¼‰ã‚’å°å…¥ã™ã‚‹äº‹ã¯æ˜¨ä»Šã®ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã ã¨æ€ã„ã¾ã™ãŒã€
ã“ã‚Œã‚‰ã«å…±é€šã™ã‚‹ç‚¹ã¨ã—ã¦ã¯L7ã§çµ‚ç«¯ã—ã¦ã„ã‚‹ã¨è¨€ã†ã“ã¨ã§ã™ã€‚

```mermaid

flowchart LR
 node_5(["User"])
subgraph VPC
  node_1["ALB"]
  node_2["WAF"]
  subgraph EKS
   node_3["envoy proxy"]
   node_4["Application(Pod)"]
   node_3 --> node_4
  end
   node_1 --> node_2
end
 node_5 --> node_1
 node_2 --> node_3

```

ã‚‚ã¡ã‚ã‚“ã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ã¦APIã‚µãƒ¼ãƒãŒä¹±ç«‹ã—ã¦ã„ã‚‹ã‚ˆã†ãªçŠ¶æ³ã ã£ãŸå ´åˆã€L7ã§çµ‚ç«¯ã—ã¦ã„ã‚‹ç®‡æ‰€ã§å¿…ãšã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

Websocketã«é–¢ã—ã¦ã¯ã€TCPã‚„HTTPä»¥ä¸Šã« Ping Pongãªã©ã®è¿½åŠ å‡¦ç†ã‚‚ç™ºç”Ÿã—ã¾ã™ã€‚

https://datatracker.ietf.org/doc/html/rfc6455#section-5.5.2

ã“ã‚Œã‚‰ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç¶­æŒã«é–¢ã™ã‚‹å“è³ªã‚’æ‹…ä¿ã—ã‚ˆã†ã¨æ€ã†ã¨ã€ã‹ãªã‚Šç´°ã‹ã„å®Ÿè£…ãŒå¿…è¦ã«ãªã‚Šã€ãƒã‚°ãŒç™ºç”Ÿã—ãŸå ´åˆã«å½±éŸ¿ç¯„å›²ãŒåºƒã™ãã¦è¿½ãˆãªã„ã“ã¨ãŒéå¸¸ã«å¤šãå­˜åœ¨ã™ã‚‹ã¨æ€ã„ã¾ã™ã€‚

## å®Ÿéš›ã«ç™ºç”Ÿã—ãŸå½±éŸ¿

Websocketæ¥ç¶šã‚’è¡Œã£ã¦ã„ãŸéš›ã«çªç„¶ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒåˆ‡æ–­ã•ã‚ŒãŸã®ã§ã™ãŒã€ã‚µãƒ¼ãƒå´ã¯ãã‚Œã‚’æ¤œçŸ¥å‡ºæ¥ã¦ã„ãªã„ã€‚ã€‚
ã¨ã„ã£ãŸçŠ¶æ³ã«å‡ºãã‚ã—ã¾ã—ãŸã€‚

ãã®éšœå®³å†…å®¹ã«ã¤ã„ã¦æ·±ãè¿½æ±‚ã¯ã—ã¾ã›ã‚“ãŒã€ã©ã†ã‚„ã‚‰ALBã‚„WAFãªã©ãŒã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼µã‚Šã£ã±ãªã—ã§åˆ‡æ–­ã‚’æ¤œçŸ¥å‡ºæ¥ã¦ã„ãªã„çŠ¶æ³ã«é™¥ã£ãŸã‚‰ã—ãã€PingPongã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ã§æ•°ç§’é–“ã¤ãªãŒã£ã¦ã„ãªã„ã‚ˆã†ãªç¾è±¡ãŒã‚ã‚Šã¾ã—ãŸã€‚

ã“ã†ã„ã£ãŸã“ã¨ãŒç™ºç”Ÿã™ã‚‹åŸå› ã¯ã€ç´›ã‚Œã‚‚ãªãè‡ªå‰ã§è«¸ã€…ã®å®Ÿè£…ã‚’ã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚
æ­£ã—ã„çŸ¥è­˜ã§æ·±ã„ãƒ‰ãƒ¡ã‚¤ãƒ³çŸ¥è­˜ã‚’æŒã£ã¦ã„ã‚‹çŠ¶æ…‹ã«ãªã£ã¦é‹ç”¨ä¿å®ˆã™ã‚‹ã®ãªã‚‰è‰¯ã„ã§ã™ãŒã€ä¼šç¤¾å‹¤ã‚ã‚’ã—ã¦ã„ãŸã‚‰ãã†ã¯ã„ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

ãªã®ã§ã€ã€Œä¸‡äººãŒã‚ã‚‹ç¨‹åº¦ã®çŸ¥è­˜é‡ã§ã‚‚ç°¡å˜ã«é‹ç”¨ä¿å®ˆã§ãã‚‹çŠ¶æ…‹ã€ã¨ã„ã†ã®ãŒè‰¯ã‹ã£ãŸã‚Šã‚‚ã—ã¾ã™ã€‚

â€»ã‚‚ã¡ã‚ã‚“ã€AWS API Gatewayã«ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ã—ã¦ã—ã¾ã†ã¨ã„ã†ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚‚ã‚ã‚Šã¾ã™ã®ã§ã€ãƒ¡ãƒªãƒ‡ãƒ¡ã‚’ã—ã£ã‹ã‚Šæ•´ç†ã—ãŸä¸Šã§ãƒªã‚¹ã‚¯ã‚’ã©ã†è©•ä¾¡ã™ã‚‹ã‹ã‚’åŸå‘³ã—ã¦ãã ã•ã„ã€‚

## AWS API Gateway

https://aws.amazon.com/jp/api-gateway/ 

> ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰å‹ã‚µãƒ¼ãƒ“ã‚¹ã® Amazon API Gateway ã‚’åˆ©ç”¨ã™ã‚Œã°ã€ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ã¯è¦æ¨¡ã«ã‹ã‹ã‚ã‚‰ãšç°¡å˜ã« API ã®ä½œæˆã€å…¬é–‹ã€ä¿å®ˆã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã€ä¿è­·ã‚’è¡Œãˆã¾ã™ã€‚API ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€æ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ã€Œãƒ•ãƒ­ãƒ³ãƒˆãƒ‰ã‚¢ã€ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚API Gateway ã‚’ä½¿ç”¨ã™ã‚Œã°ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæ–¹å‘é€šä¿¡ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿç¾ã™ã‚‹ RESTful API ãŠã‚ˆã³ WebSocket API ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚API Gateway ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã•ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã®ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚„ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

![](https://d1.awsstatic.com/serverless/New-API-GW-Diagram.c9fc9835d2a9aa00ef90d0ddc4c6402a2536de0d.png)

â€»å…¬å¼ã‚µã‚¤ãƒˆå¼•ç”¨

è¨˜è¿°ã®é€šã‚Šã§ã™ãŒã€ä»Šå›ã¯Socketé€šä¿¡ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç½®ã„ã¦ã„ã¾ã™ã®ã§ `WebSocket API` ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

> ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¨ã„ã£ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæ–¹å‘é€šä¿¡ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€WebSocket API ã‚’ä½¿ç”¨ã—ã¦æ§‹ç¯‰ã§ãã¾ã™ã€‚API Gateway ã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è»¢é€ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«æ°¸ç¶šçš„ãªæ¥ç¶šã‚’ç¶­æŒã—ã¾ã™ã€‚

ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹é€šã‚Šã€ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼µã‚‹ã¨ã„ã†å‰å¤§ãªä½œæ¥­ã‚’ãƒãƒãƒ¼ã‚¸ãƒ‰ã—ã¦ãã‚Œã¾ã™ã€‚éå¸¸ã«ã‚ã‚ŠãŒãŸã„ã§ã™ã­ã€‚

https://docs.aws.amazon.com/apigateway/latest/developerguide/websocket-api-chat-app.html

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«ã‚‚ã‚ã‚Šã¾ã™ãŒã€WebSocket APIã§ã¯Lambdaã‚’ä¸­å¿ƒã¨ã—ã¦ `$connect` ãªã©ã®è­˜åˆ¥å­ã«ã‚ˆã£ã¦ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç™ºç”Ÿæ™‚ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŒã„ãŸã‚Šãªã©ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚


## Terraform ã§æ§‹ç¯‰ã™ã‚‹

ãƒªã‚½ãƒ¼ã‚¹ã¨ã—ã¦ã¯å˜ç´”ã§ä»¥ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹ã§API Gatewayã¯æ§‹ç¯‰å‡ºæ¥ã¾ã™ã€‚
ãŸã ã€ã©ã“ã«ã‚‚æ¥ç¶šã•ã‚Œã¦ã„ãªã„ã®ã§Lambdaãªã©ã¨ä¸€ç·’ã«Routeç­‰ã®è¨­å®šã‚‚è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```tf
resource "aws_apigatewayv2_api" "chat_websocket" {
  name                       = "chat_websocket"
  protocol_type              = "WEBSOCKET"
  description                = "Realtime Chat Socket Connections"
  route_selection_expression = "$request.body.action"
}
```

å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚’è§£èª¬ã—ã¦ã‚‹ã¨æ—¥ãŒæš®ã‚Œã‚‹ã®ã§ã€ã¨ã‚Šã‚ãˆãšå‹•ãã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¦ãŠãã¾ã™ã€‚


```tf
# APIã§ã„ã†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ, ã“ã“ã§ã¯ $coonectï¼ˆæ¥ç¶šæ™‚ï¼‰ã®ãƒªã‚½ãƒ¼ã‚¹
resource "aws_apigatewayv2_route" "chat_websocket_connet" {
  api_id    = aws_apigatewayv2_api.chat_websocket.id
  route_key = "$connect"
  target    = "integrations/${aws_apigatewayv2_integration.chat_websocket_connet.id}"
}

# Lambdaã¨ç´ä»˜ã‘ã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ Lambdaã«å¯¾ã—ã¦POSTãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹
resource "aws_apigatewayv2_integration" "chat_websocket_connet" {
  api_id             = aws_apigatewayv2_api.chat_websocket.id
  integration_type   = "AWS_PROXY"
  integration_method = "POST"
  integration_uri    = aws_lambda_function.chat_websocket_handler_connect.invoke_arn
}

# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ã‚¸ã®ç®¡ç†
resource "aws_apigatewayv2_stage" "chat_websocket_stage" {
  api_id = aws_apigatewayv2_api.chat_websocket.id
  name   = "chat_websocket"

  default_route_settings {
    data_trace_enabled       = true
    detailed_metrics_enabled = true
    logging_level            = "INFO"
    throttling_burst_limit   = 5000
    throttling_rate_limit    = 10000
  }

  deployment_id = aws_apigatewayv2_deployment.chat_websocket_deployment.id
  depends_on    = [aws_apigatewayv2_deployment.chat_websocket_deployment]

  access_log_settings {
    destination_arn = aws_cloudwatch_log_group.api_gw.arn
    format          = "$context.identity.sourceIp - - [$context.requestTime] \"$context.httpMethod $context.routeKey $context.protocol\" $context.status $context.responseLength $context.requestId $context.integrationErrorMessage"
  }
}

# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®ç®¡ç†
resource "aws_apigatewayv2_deployment" "chat_websocket_deployment" {
  api_id      = aws_apigatewayv2_api.chat_websocket.id
  description = "chat_websocket_deployment"

  triggers = {
    redeployment = sha1(join(",", tolist([
      jsonencode(aws_apigatewayv2_integration.chat_websocket_connet),
      jsonencode(aws_apigatewayv2_route.chat_websocket_connet),
    ])))
  }

  lifecycle {
    create_before_destroy = true
  }
}

# ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã‚¢ã‚¿ãƒƒãƒ
resource "aws_apigatewayv2_domain_name" "chat_websocket_domain" {
  domain_name = local.route53_domain_socket_api_gateway

  domain_name_configuration {
    certificate_arn = module.acm.arn
    endpoint_type   = "REGIONAL"
    security_policy = "TLS_1_2"
  }
}

# ã‚¹ãƒ†ãƒ¼ã‚¸ã¨ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒãƒƒãƒ”ãƒ³ã‚°
resource "aws_apigatewayv2_api_mapping" "chat_websocket_domain_mapping" {
  api_id      = aws_apigatewayv2_api.chat_websocket.id
  domain_name = aws_apigatewayv2_domain_name.chat_websocket_domain.id
  stage       = aws_apigatewayv2_stage.chat_websocket_stage.id
}

# API Gatewayã‹ã‚‰Lambdaã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹
resource "aws_lambda_permission" "connect_handler" {
  statement_id  = "AllowExecutionFromAPIGateway"
  action        = "lambda:InvokeFunction"
  function_name = aws_lambda_function.chat_websocket_handler_connect.function_name
  principal     = "apigateway.amazonaws.com"
  source_arn    = "arn:aws:execute-api:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:${aws_apigatewayv2_api.chat_websocket.id}/*/${aws_apigatewayv2_route.chat_websocket_connet.route_key}"
}
```

ä¸€éƒ¨åˆ¥ã®Moduleã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ãŒã€åŸºæœ¬ã¯å‹•ä½œã™ã‚‹ã¨æ€ã„ã¾ã™ã€‚

- åˆ¥ã§ç«‹ã¦ã¦ã„ã‚‹ã‚‚ã®
  - Route53, ACMãªã©ãƒ‰ãƒ¡ã‚¤ãƒ³é–¢é€£
  - Lambdaé–¢æ•°

## å‹•ä½œç¢ºèª

å‰²ã‚Šå½“ã¦ãŸãƒ‰ãƒ¡ã‚¤ãƒ³åã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹äº‹ãŒå‡ºæ¥ã¾ã™ã€‚

```sh
wscat -c "wss://******?room_id=***" -H "Authorization:****"
```

ã»ã¨ã‚“ã©ãƒã‚¹ã‚¯ã—ã¦ã„ã¾ã™ãŒã€ã€ã“ã‚Œã§ ã‚¢ã‚¯ã‚»ã‚¹å‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## æ¬¡å›: JWTèªè¨¼

ã“ã®è¨˜äº‹ã®ç¶šãã§ã‚ã‚‹èªè¨¼å›ã‚Šã®è©±ã‚’å¼•ãç¶šãã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚

ä»Šå›ã¯åŸºæœ¬çš„ãªéƒ¨åˆ†ã®å°å…¥ã®è§£èª¬ã§ã—ãŸã€‚
èªè¨¼ã®ä»•çµ„ã¿ã‚„Lambdaå‘¨ã‚Šã®POSTãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„æ–¹ãªã©ã¯åˆ¥ã®è¨˜äº‹ã§è§£èª¬ã«ãªã‚Šã¾ã™ã€‚


