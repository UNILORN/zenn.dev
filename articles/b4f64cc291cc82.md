---
title: "Socket通信はAPIGateway+Lambda+DynamoDBに任せよう"
emoji: "💨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["AWS", "AWS API Gateway", "lambda", "DynamoDB", "terraform"]
published: false
---

皆さんはSocket通信を利用されているでしょうか。
私は結構な頻度で使っています。

例えば、外部に公開していないネットワーク内部の端末からデータを吸い上げたい時皆さんはどうしていますか？

VPNを張ったり..? 

こういったケースではSocket通信をすると比較的簡単に実装できます。

https://tech-blog.optim.co.jp/entry/2022/05/30/100000

私が執筆した記事ですが、この技術もSocket通信を応用しています。

## WebSocketやHTTP Keep-Alive,Persistentを利用した懸念点

https://tex2e.github.io/rfc-translater/html/rfc7540.html

> 9.1. Connection Management
> 
> HTTP/2 connections are persistent. 

このあたりを見ても、接続管理に非常に苦労することが分かります。

インフラの構成として、WAFたALB、リバースプロキシ（Envoyやistio）を導入する事は昨今のデファクトだと思いますが、
これらに共通する点としてはL7で終端していると言うことです。

```mermaid

flowchart LR
 node_5(["User"])
subgraph VPC
  node_1["ALB"]
  node_2["WAF"]
  subgraph EKS
   node_3["envoy proxy"]
   node_4["Application(Pod)"]
   node_3 --> node_4
  end
   node_1 --> node_2
end
 node_5 --> node_1
 node_2 --> node_3

```

もちろん、マイクロサービスアーキテクチャを採用してAPIサーバが乱立しているような状況だった場合、L7で終端している箇所で必ずコネクション管理が必要になります。

Websocketに関しては、TCPやHTTP以上に Ping Pongなどの追加処理も発生します。

https://datatracker.ietf.org/doc/html/rfc6455#section-5.5.2

これらのコネクション維持に関する品質を担保しようと思うと、かなり細かい実装が必要になり、バグが発生した場合に影響範囲が広すぎて追えないことが非常に多く存在すると思います。

## 実際に発生した影響

Websocket接続を行っていた際に突然コネクションが切断されたのですが、サーバ側はそれを検知出来ていない。。
といった状況に出くわしました。

その障害内容について深く追求はしませんが、どうやらALBやWAFなどがコネクションを張りっぱなしで切断を検知出来ていない状況に陥ったらしく、PingPongのタイムアウトまで数秒間つながっていないような現象がありました。

