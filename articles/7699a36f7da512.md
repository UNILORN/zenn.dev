---
title: "Socketé€šä¿¡ã¯APIGateway+Lambda+DynamoDBã«ä»»ã›ã‚ˆã†ï¼ˆ3ï¼‰"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "apigateway", "lambda", "DynamoDB", "terraform", "go"]
published: false
---

å‰å›ã®è¨˜äº‹ã®ç¶šãã§ã™ã€‚

ä»Šå›ã¯DynamoDBã‚’ä½¿ã£ãŸWebSocketã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

## WebSocketã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã®å¿…è¦æ€§

WebSocketAPIã‚’ä½¿ç”¨ã™ã‚‹éš›ã€æœ€ã‚‚é‡è¦ãªã“ã¨ã®ä¸€ã¤ãŒã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã®ç®¡ç†ã§ã™ã€‚

```mermaid

flowchart TB
    node_1["Client A"]
    node_2["Client B"]
    node_3["Client C"]
    node_4["API Gateway"]
    node_5["Lambda"]
    node_6["DynamoDB"]
    
    node_1 --> node_4
    node_2 --> node_4
    node_3 --> node_4
    node_4 --> node_5
    node_5 --> node_6
    
    node_5 -."ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡".-> node_4
    node_4 -."ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡".-> node_1
    node_4 -."ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡".-> node_2
    node_4 -."ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡".-> node_3

```

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒWebSocketã«æ¥ç¶šã™ã‚‹ã¨ã€API Gatewayã¯ä¸€æ„ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆã—ã¾ã™ã€‚
ã“ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³IDã‚’ä½¿ã£ã¦ã€ç‰¹å®šã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸã‚Šã€ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé…ä¿¡ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ã—ã‹ã—ã€ã©ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã©ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³IDã‚’æŒã£ã¦ã„ã‚‹ã‹ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãã“ã§æ´»èºã™ã‚‹ã®ãŒDynamoDBã§ã™ã€‚

## DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã®è¨­è¨ˆ

WebSocketã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã®ãŸã‚ã®DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¨­è¨ˆã—ã¾ã™ã€‚

```tf
# DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ« - WebSocket ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
resource "aws_dynamodb_table" "chat_connection" {
  name           = "chat_connections"
  billing_mode   = "PAY_PER_REQUEST"
  hash_key       = "connection_id"

  attribute {
    name = "connection_id"
    type = "S"
  }

  attribute {
    name = "room_id"
    type = "S"
  }

  attribute {
    name = "user_id"
    type = "S"
  }

  attribute {
    name = "ttl"
    type = "N"
  }

  # TTLè¨­å®š - å¤ã„ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•å‰Šé™¤
  ttl {
    attribute_name = "ttl"
    enabled        = true
  }

  # room_idã§ã‚¯ã‚¨ãƒªã™ã‚‹ãŸã‚ã®GSI
  global_secondary_index {
    name     = "room_id-index"
    hash_key = "room_id"
  }

  # user_idã§ã‚¯ã‚¨ãƒªã™ã‚‹ãŸã‚ã®GSI
  global_secondary_index {
    name     = "user_id-index"
    hash_key = "user_id"
  }

  tags = {
    Name = "chat_connections"
  }
}
```

- `connection_id`: ãƒ—ãƒ©ã‚¤ãƒãƒªã‚­ãƒ¼ï¼ˆAPI GatewayãŒç”Ÿæˆã™ã‚‹ä¸€æ„IDï¼‰
- `room_id`: ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã®ID
- `user_id`: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ID
- `ttl`: Time To Liveï¼ˆè‡ªå‹•å‰Šé™¤ç”¨ï¼‰
- GSIï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ã§åŠ¹ç‡çš„ãªã‚¯ã‚¨ãƒªã‚’å®Ÿç¾

## Lambdaé–¢æ•°ã®å®Ÿè£… - ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†

### $connect ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

WebSocketæ¥ç¶šæ™‚ã«ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’DynamoDBã«ä¿å­˜ã—ã¾ã™ã€‚

```go
package main

import (
	"context"
	"encoding/json"
	"fmt"
	"os"
	"strconv"
	"time"

	"github.com/aws/aws-lambda-go/events"
	"github.com/aws/aws-lambda-go/lambda"
	"github.com/aws/aws-sdk-go-v2/aws"
	"github.com/aws/aws-sdk-go-v2/config"
	"github.com/aws/aws-sdk-go-v2/service/dynamodb"
	"github.com/aws/aws-sdk-go-v2/service/dynamodb/types"
)

type ConnectionData struct {
	ConnectionID string `json:"connection_id"`
	RoomID       string `json:"room_id"`
	UserID       string `json:"user_id"`
	TTL          int64  `json:"ttl"`
	CreatedAt    string `json:"created_at"`
}

var dynamoClient *dynamodb.Client
var tableName string

func init() {
	cfg, err := config.LoadDefaultConfig(context.TODO())
	if err != nil {
		panic(fmt.Sprintf("unable to load SDK config, %v", err))
	}
	dynamoClient = dynamodb.NewFromConfig(cfg)
	tableName = os.Getenv("DYNAMO_TABLE_NAME_CHAT_CONNECTIONS")
}

func connectHandler(ctx context.Context, request events.APIGatewayWebsocketProxyRequest) (events.APIGatewayProxyResponse, error) {
	// JWTæ¤œè¨¼ï¼ˆå‰å›ã®è¨˜äº‹ã§å®Ÿè£…æ¸ˆã¿ï¼‰
	tokenString := request.QueryStringParameters["token"]
	if tokenString == "" {
		return events.APIGatewayProxyResponse{
			StatusCode: 401,
			Body:       "Unauthorized: missing token",
		}, nil
	}

	if err := verifyToken(tokenString); err != nil {
		return events.APIGatewayProxyResponse{
			StatusCode: 401,
			Body:       fmt.Sprintf("Unauthorized: %v", err),
		}, nil
	}

	// JWTã‹ã‚‰room_idã¨user_idã‚’å–å¾—
	roomID := request.QueryStringParameters["room_id"]
	userID := request.QueryStringParameters["user_id"]

	if roomID == "" || userID == "" {
		return events.APIGatewayProxyResponse{
			StatusCode: 400,
			Body:       "Bad Request: missing room_id or user_id",
		}, nil
	}

	// ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä½œæˆ
	connectionData := ConnectionData{
		ConnectionID: request.RequestContext.ConnectionID,
		RoomID:       roomID,
		UserID:       userID,
		TTL:          time.Now().Add(24 * time.Hour).Unix(), // 24æ™‚é–“å¾Œã«è‡ªå‹•å‰Šé™¤
		CreatedAt:    time.Now().Format(time.RFC3339),
	}

	// DynamoDBã«ä¿å­˜
	item := map[string]types.AttributeValue{
		"connection_id": &types.AttributeValueMemberS{Value: connectionData.ConnectionID},
		"room_id":       &types.AttributeValueMemberS{Value: connectionData.RoomID},
		"user_id":       &types.AttributeValueMemberS{Value: connectionData.UserID},
		"ttl":           &types.AttributeValueMemberN{Value: strconv.FormatInt(connectionData.TTL, 10)},
		"created_at":    &types.AttributeValueMemberS{Value: connectionData.CreatedAt},
	}

	_, err := dynamoClient.PutItem(ctx, &dynamodb.PutItemInput{
		TableName: aws.String(tableName),
		Item:      item,
	})

	if err != nil {
		return events.APIGatewayProxyResponse{
			StatusCode: 500,
			Body:       fmt.Sprintf("Internal Server Error: %v", err),
		}, nil
	}

	return events.APIGatewayProxyResponse{
		StatusCode: 200,
		Body:       "Connected successfully",
	}, nil
}

func main() {
	lambda.Start(connectHandler)
}
```

### $disconnect ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

WebSocketåˆ‡æ–­æ™‚ã«ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’DynamoDBã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚

```go
func disconnectHandler(ctx context.Context, request events.APIGatewayWebsocketProxyRequest) (events.APIGatewayProxyResponse, error) {
	// DynamoDBã‹ã‚‰ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å‰Šé™¤
	_, err := dynamoClient.DeleteItem(ctx, &dynamodb.DeleteItemInput{
		TableName: aws.String(tableName),
		Key: map[string]types.AttributeValue{
			"connection_id": &types.AttributeValueMemberS{Value: request.RequestContext.ConnectionID},
		},
	})

	if err != nil {
		return events.APIGatewayProxyResponse{
			StatusCode: 500,
			Body:       fmt.Sprintf("Internal Server Error: %v", err),
		}, nil
	}

	return events.APIGatewayProxyResponse{
		StatusCode: 200,
		Body:       "Disconnected successfully",
	}, nil
}
```

## ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ©Ÿèƒ½ã®å®Ÿè£…

### ç‰¹å®šã®ãƒ«ãƒ¼ãƒ ã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡

```go
func sendMessageHandler(ctx context.Context, request events.APIGatewayWebsocketProxyRequest) (events.APIGatewayProxyResponse, error) {
	var messageData struct {
		RoomID  string `json:"room_id"`
		Message string `json:"message"`
	}

	if err := json.Unmarshal([]byte(request.Body), &messageData); err != nil {
		return events.APIGatewayProxyResponse{
			StatusCode: 400,
			Body:       "Bad Request: invalid JSON",
		}, nil
	}

	// æŒ‡å®šã•ã‚ŒãŸroomã«æ¥ç¶šã—ã¦ã„ã‚‹å…¨ã¦ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
	connections, err := getConnectionsByRoomID(ctx, messageData.RoomID)
	if err != nil {
		return events.APIGatewayProxyResponse{
			StatusCode: 500,
			Body:       fmt.Sprintf("Internal Server Error: %v", err),
		}, nil
	}

	// API Gateway Management APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
	apiGatewayURL := fmt.Sprintf("https://%s.execute-api.%s.amazonaws.com/%s",
		request.RequestContext.APIID,
		os.Getenv("AWS_REGION"),
		request.RequestContext.Stage,
	)

	managementConfig, err := config.LoadDefaultConfig(ctx)
	if err != nil {
		return events.APIGatewayProxyResponse{
			StatusCode: 500,
			Body:       fmt.Sprintf("Failed to load AWS config: %v", err),
		}, nil
	}

	managementClient := apigatewaymanagementapi.NewFromConfig(managementConfig, func(o *apigatewaymanagementapi.Options) {
		o.BaseEndpoint = aws.String(apiGatewayURL)
	})

	// å„ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
	for _, connection := range connections {
		messageBytes, _ := json.Marshal(map[string]interface{}{
			"action":  "message",
			"room_id": messageData.RoomID,
			"message": messageData.Message,
			"timestamp": time.Now().Format(time.RFC3339),
		})

		_, err := managementClient.PostToConnection(ctx, &apigatewaymanagementapi.PostToConnectionInput{
			ConnectionId: aws.String(connection.ConnectionID),
			Data:         messageBytes,
		})

		if err != nil {
			// ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ãªå ´åˆã¯DynamoDBã‹ã‚‰å‰Šé™¤
			if isConnectionGone(err) {
				deleteConnection(ctx, connection.ConnectionID)
			}
		}
	}

	return events.APIGatewayProxyResponse{
		StatusCode: 200,
		Body:       "Message sent successfully",
	}, nil
}

func getConnectionsByRoomID(ctx context.Context, roomID string) ([]ConnectionData, error) {
	result, err := dynamoClient.Query(ctx, &dynamodb.QueryInput{
		TableName:              aws.String(tableName),
		IndexName:              aws.String("room_id-index"),
		KeyConditionExpression: aws.String("room_id = :room_id"),
		ExpressionAttributeValues: map[string]types.AttributeValue{
			":room_id": &types.AttributeValueMemberS{Value: roomID},
		},
	})

	if err != nil {
		return nil, err
	}

	var connections []ConnectionData
	for _, item := range result.Items {
		var connection ConnectionData
		// DynamoDBã®çµæœã‚’ãƒ‘ãƒ¼ã‚¹
		if connID, ok := item["connection_id"].(*types.AttributeValueMemberS); ok {
			connection.ConnectionID = connID.Value
		}
		if roomID, ok := item["room_id"].(*types.AttributeValueMemberS); ok {
			connection.RoomID = roomID.Value
		}
		if userID, ok := item["user_id"].(*types.AttributeValueMemberS); ok {
			connection.UserID = userID.Value
		}
		connections = append(connections, connection)
	}

	return connections, nil
}

func isConnectionGone(err error) bool {
	// API Gateway Management APIã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
	// 410 Gone ã‚„ 403 Forbidden ã®å ´åˆã¯ç„¡åŠ¹ãªã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³
	return true // ç°¡ç•¥åŒ–
}

func deleteConnection(ctx context.Context, connectionID string) {
	dynamoClient.DeleteItem(ctx, &dynamodb.DeleteItemInput{
		TableName: aws.String(tableName),
		Key: map[string]types.AttributeValue{
			"connection_id": &types.AttributeValueMemberS{Value: connectionID},
		},
	})
}
```

## Terraformã§ã®è¿½åŠ è¨­å®š

Lambdaé–¢æ•°ã«DynamoDBã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ä»˜ä¸ã—ã€API Gateway Management APIã®æ¨©é™ã‚‚è¿½åŠ ã—ã¾ã™ã€‚

```tf
# Lambdaå®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã«DynamoDBã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è¿½åŠ 
resource "aws_iam_role_policy" "chat_websocket_lambda_dynamodb_policy" {
  name = "chat_websocket_lambda_dynamodb_policy"
  role = aws_iam_role.chat_websocket_handler_connect_lambda_role.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "dynamodb:PutItem",
          "dynamodb:GetItem",
          "dynamodb:DeleteItem",
          "dynamodb:Query",
          "dynamodb:Scan"
        ]
        Resource = [
          aws_dynamodb_table.chat_connection.arn,
          "${aws_dynamodb_table.chat_connection.arn}/index/*"
        ]
      },
      {
        Effect = "Allow"
        Action = [
          "execute-api:ManageConnections"
        ]
        Resource = "arn:aws:execute-api:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:${aws_apigatewayv2_api.chat_websocket.id}/*"
      }
    ]
  })
}

# $disconnectç”¨ã®Lambdaé–¢æ•°
resource "aws_lambda_function" "chat_websocket_handler_disconnect" {
  function_name = "${local.lambda_name}-disconnect"
  role          = aws_iam_role.chat_websocket_handler_connect_lambda_role.arn
  package_type  = "Image"
  image_uri     = "${local.ecr_registry}/${local.lambda_image_ecr_repository_name}:${var.api_gateway_websocket_disconnect_lambda_image_tag}"
  timeout       = 30

  environment {
    variables = {
      DYNAMO_TABLE_NAME_CHAT_CONNECTIONS = aws_dynamodb_table.chat_connection.name
    }
  }
}

# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ç”¨ã®Lambdaé–¢æ•°
resource "aws_lambda_function" "chat_websocket_handler_send_message" {
  function_name = "${local.lambda_name}-send-message"
  role          = aws_iam_role.chat_websocket_handler_connect_lambda_role.arn
  package_type  = "Image"
  image_uri     = "${local.ecr_registry}/${local.lambda_image_ecr_repository_name}:${var.api_gateway_websocket_send_message_lambda_image_tag}"
  timeout       = 30

  environment {
    variables = {
      DYNAMO_TABLE_NAME_CHAT_CONNECTIONS = aws_dynamodb_table.chat_connection.name
    }
  }
}

# $disconnectç”¨ã®API Gatewayè¨­å®š
resource "aws_apigatewayv2_route" "chat_websocket_disconnect" {
  api_id    = aws_apigatewayv2_api.chat_websocket.id
  route_key = "$disconnect"
  target    = "integrations/${aws_apigatewayv2_integration.chat_websocket_disconnect.id}"
}

resource "aws_apigatewayv2_integration" "chat_websocket_disconnect" {
  api_id             = aws_apigatewayv2_api.chat_websocket.id
  integration_type   = "AWS_PROXY"
  integration_method = "POST"
  integration_uri    = aws_lambda_function.chat_websocket_handler_disconnect.invoke_arn
}

# sendMessageç”¨ã®API Gatewayè¨­å®š
resource "aws_apigatewayv2_route" "chat_websocket_send_message" {
  api_id    = aws_apigatewayv2_api.chat_websocket.id
  route_key = "sendMessage"
  target    = "integrations/${aws_apigatewayv2_integration.chat_websocket_send_message.id}"
}

resource "aws_apigatewayv2_integration" "chat_websocket_send_message" {
  api_id             = aws_apigatewayv2_api.chat_websocket.id
  integration_type   = "AWS_PROXY"
  integration_method = "POST"
  integration_uri    = aws_lambda_function.chat_websocket_handler_send_message.invoke_arn
}

# Lambdaå®Ÿè¡Œæ¨©é™
resource "aws_lambda_permission" "disconnect_handler" {
  statement_id  = "AllowExecutionFromAPIGateway"
  action        = "lambda:InvokeFunction"
  function_name = aws_lambda_function.chat_websocket_handler_disconnect.function_name
  principal     = "apigateway.amazonaws.com"
  source_arn    = "arn:aws:execute-api:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:${aws_apigatewayv2_api.chat_websocket.id}/*/$disconnect"
}

resource "aws_lambda_permission" "send_message_handler" {
  statement_id  = "AllowExecutionFromAPIGateway"
  action        = "lambda:InvokeFunction"
  function_name = aws_lambda_function.chat_websocket_handler_send_message.function_name
  principal     = "apigateway.amazonaws.com"
  source_arn    = "arn:aws:execute-api:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:${aws_apigatewayv2_api.chat_websocket.id}/*/sendMessage"
}
```

## å‹•ä½œç¢ºèª

å®Ÿéš›ã«WebSocketã«æ¥ç¶šã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€å—ä¿¡ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

JavaScriptã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µãƒ³ãƒ—ãƒ«ï¼š

```javascript
// WebSocketæ¥ç¶š
const token = "your-jwt-token";
const roomId = "room-123";
const userId = "user-456";

const ws = new WebSocket(`wss://your-api-gateway-url.execute-api.region.amazonaws.com/dev?token=${token}&room_id=${roomId}&user_id=${userId}`);

ws.onopen = function(event) {
    console.log('WebSocket connection established');
};

ws.onmessage = function(event) {
    const message = JSON.parse(event.data);
    console.log('Received message:', message);
};

ws.onerror = function(error) {
    console.error('WebSocket error:', error);
};

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
function sendMessage(message) {
    const data = {
        action: "sendMessage",
        room_id: roomId,
        message: message
    };
    ws.send(JSON.stringify(data));
}

// ä½¿ç”¨ä¾‹
sendMessage("Hello, World!");
```

## ç›£è¦–ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹

DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã®èª­ã¿æ›¸ãã¨WebSocketã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³æ•°ã®ç›£è¦–ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```tf
# CloudWatch Alarm - DynamoDBèª­ã¿å–ã‚Šå®¹é‡
resource "aws_cloudwatch_metric_alarm" "dynamodb_read_throttle" {
  alarm_name          = "chat-connections-read-throttle"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = "2"
  metric_name         = "ReadThrottleEvents"
  namespace           = "AWS/DynamoDB"
  period              = "300"
  statistic           = "Sum"
  threshold           = "0"
  alarm_description   = "DynamoDB read throttle events"

  dimensions = {
    TableName = aws_dynamodb_table.chat_connection.name
  }
}

# CloudWatch Alarm - WebSocketæ¥ç¶šæ•°
resource "aws_cloudwatch_metric_alarm" "websocket_connection_count" {
  alarm_name          = "websocket-high-connection-count"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = "2"
  metric_name         = "ConnectCount"
  namespace           = "AWS/ApiGateway"
  period              = "300"
  statistic           = "Sum"
  threshold           = "1000"
  alarm_description   = "High WebSocket connection count"

  dimensions = {
    ApiName = aws_apigatewayv2_api.chat_websocket.name
  }
}
```

## ã¾ã¨ã‚

DynamoDBã‚’ä½¿ã£ãŸWebSocketã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã—ãŸã€‚

- DynamoDBã®TTLæ©Ÿèƒ½ã‚’ä½¿ã£ãŸè‡ªå‹•å‰Šé™¤
- GSIï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªã‚¯ã‚¨ãƒª
- API Gateway Management APIã‚’ä½¿ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
- ç„¡åŠ¹ãªã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã®è‡ªå‹•å‰Šé™¤

ã“ã‚Œã§ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªWebSocketã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºç›¤ãŒå®Œæˆã—ã¾ã—ãŸã€‚
DynamoDBã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç‰¹æ€§ã«ã‚ˆã‚Šã€æ¥ç¶šæ•°ã«å¿œã˜ãŸè‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãŒå¯èƒ½ã§ã™ã€‚

