---
title: "API Gatewayã¨Step Functionsã‚’Terraformã§ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹APIã‚’æ§‹ç¯‰ã™ã‚‹"
emoji: "ğŸš€"
type: "tech"
topics: ["aws", "terraform", "apigateway", "stepfunctions", "serverless"]
published: true
---

## ã¯ã˜ã‚ã«

AWS Summit 2025ã¸å‚åŠ ã—ã€Step Functionã ã‘ã§APIã®å‡¦ç†ã‚’è¡Œã†... ã¨ã„ã†ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¦‹ã¦æ„ŸåŒ–ã•ã‚ŒãŸã®ã§ã“ã®è¨˜äº‹ã‚’åŸ·ç­†ã—ã‚ˆã†ã¨æ€ã„ã¾ã—ãŸã€‚

ä»Šå›ã¯ã€AWSä¸Šã§ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãªAPIã‚’æ§‹ç¯‰ã™ã‚‹éš›ã«ã€å¤šãã®å ´åˆã§æ¡ç”¨ã•ã‚Œã‚‹Lambdaã‚’**ã‚ãˆã¦åˆ©ç”¨ã›ãš**ã«ã€API Gatewayã¨Step Functionsã‚’ç›´æ¥é€£æºã•ã›ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

é€šå¸¸ã€API Gatewayã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã¯Lambdaã‚’é…ç½®ã—ã¦ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ãŒã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å†…å®¹ã«å¿œã˜ã¦å‡¦ç†ã‚’æŒ¯ã‚Šåˆ†ã‘ãŸã‚Šã€å˜ç´”ãªAWSã‚µãƒ¼ãƒ“ã‚¹é€£æºã‚’å®Ÿè¡Œã—ãŸã‚Šã™ã‚‹ã ã‘ã§ã‚ã‚Œã°ã€Step Functionsã§ååˆ†ãªã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®æ§‹æˆã®ãƒ¡ãƒªãƒƒãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

-   **Lambdaã®ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã‚’è€ƒæ…®ã—ãªãã¦è‰¯ã„**
-   **çŠ¶æ…‹ç®¡ç†ã‚„ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã‚’Step Functionsã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§è¦–è¦šçš„ã«å®šç¾©ã§ãã‚‹**
-   **Terraformã§ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚³ãƒ¼ãƒ‰åŒ–ã—ã‚„ã™ãã€ç®¡ç†ãŒå®¹æ˜“ã«ãªã‚‹**

ä»Šå›ã¯ã€ç°¡å˜ãªToDoç®¡ç†APIã‚’ä¾‹ã«ã€Terraformã‚’ä½¿ã£ã¦ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ§‹ç¯‰ã™ã‚‹æ‰‹é †ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

ä»Šå›æ§‹ç¯‰ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã®å…¨ä½“åƒã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    â”‚
    â”‚ HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ (POST /create, GET /get)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Gateway     â”‚ (HTTP API)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ AWS_PROXYçµ±åˆ
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step Functions   â”‚ (State Machine)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€ (operation: "create") â†’ DynamoDB:PutItem
    â”‚
    â””â”€ (operation: "getTodo") â†’ DynamoDB:GetItem
```

API GatewayãŒå—ã‘å–ã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç›´æ¥Step Functionsã«æ¸¡ã—ã€Step FunctionsãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ï¼ˆ`operation`ï¼‰ã«å¿œã˜ã¦DynamoDBã®æ“ä½œã‚’åˆ†å²ã•ã›ã¾ã™ã€‚

## å®Ÿè£…è§£èª¬

ãã‚Œã§ã¯ã€Terraformã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### 1. DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«

ã¾ãšã¯ã€ToDoã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚

```terraform:dynamodb.tf
resource "aws_dynamodb_table" "todo_table" {
  name         = "${var.project_name}-table"
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "id"
  range_key    = "userid"

  attribute {
    name = "id"
    type = "S"
  }

  attribute {
    name = "userid"
    type = "S"
  }

  tags = var.tags
}
```

`id`ã‚’ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ã€`userid`ã‚’ã‚½ãƒ¼ãƒˆã‚­ãƒ¼ã¨ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã€‚

### 2. Step Functions ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³

æ¬¡ã«ã€API Gatewayã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’å®šç¾©ã—ã¾ã™ã€‚

#### ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®å®šç¾© (statemachine.json)

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®šç¾©ã¯JSONã§è¡Œã„ã¾ã™ã€‚`Choice`ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ä½¿ã£ã¦ã€`operation`ã®å€¤ã«ã‚ˆã£ã¦å‡¦ç†ã‚’åˆ†å²ã•ã›ã¦ã„ã‚‹ã®ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

```json:statemachine.json
{
  "Comment": "A state machine that handles both creating and getting items from DynamoDB.",
  "StartAt": "CheckOperation",
  "States": {
    "CheckOperation": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.operation",
          "StringEquals": "create",
          "Next": "CreateItem"
        },
        {
          "Variable": "$.operation",
          "StringEquals": "getTodo",
          "Next": "GetItem"
        }
      ],
      "Default": "FailState"
    },
    "CreateItem": {
      "Type": "Task",
      "Resource": "arn:aws:states:::dynamodb:putItem",
      "Parameters": {
        "TableName": "${DYNAMODB_TABLE_NAME}",
        "Item": {
          "id": {
            "S.$": "States.UUID()"
          },
          "userId": {
            "S.$": "$.payload.userId"
          },
          "task": {
            "S.$": "$.payload.task"
          },
          "timestamp": {
            "S.$": "$$.State.EnteredTime"
          }
        }
      },
      "End": true
    },
    "GetItem": {
      "Type": "Task",
      "Resource": "arn:aws:states:::dynamodb:getItem",
      "Parameters": {
        "TableName": "${DYNAMODB_TABLE_NAME}",
        "Key": {
          "userId": {
            "S.$": "$.payload.userId"
          }
        }
      },
      "End": true
    },
    "FailState": {
      "Type": "Fail",
      "Error": "InvalidOperation",
      "Cause": "The specified operation is not supported."
    }
  }
}
```

`CreateItem`ã¨`GetItem`ã‚¿ã‚¹ã‚¯ã§ã¯ã€`Resource`ã«`arn:aws:states:::dynamodb:putItem`ã‚„`arn:aws:states:::dynamodb:getItem`ã¨ã„ã£ãŸAWS SDKçµ±åˆã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€Lambdaã‚’ä»‹ã•ãšã«ç›´æ¥DynamoDBã‚’æ“ä½œã—ã¦ã„ã¾ã™ã€‚

#### Terraformãƒªã‚½ãƒ¼ã‚¹ (stepfunctions.tf)

`terraform-aws-modules/step-functions/aws`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã„ã€å…ˆã»ã©ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚

```terraform:stepfunctions.tf
module "todo_sfn" {
  source = "terraform-aws-modules/step-functions/aws"

  name = "${var.project_name}-state-machine"
  definition = templatefile("${path.module}/statemachine.json", {
    DYNAMODB_TABLE_NAME = aws_dynamodb_table.todo_table.name
  })

  service_integrations = {
    dynamodb = {
      dynamodb = [aws_dynamodb_table.todo_table.arn]
    }
  }

  tags = var.tags
}
```
`templatefile`é–¢æ•°ã‚’ä½¿ã£ã¦ã€JSONå†…ã®å¤‰æ•° `${DYNAMODB_TABLE_NAME}` ã«å®Ÿéš›ã®ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’åŸ‹ã‚è¾¼ã‚“ã§ã„ã¾ã™ã€‚

### 3. API Gateway

æœ€å¾Œã«ã€API Gatewayã‚’å®šç¾©ã—ã¾ã™ã€‚ã“ã“ãŒä»Šå›ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ ¸å¿ƒéƒ¨åˆ†ã§ã™ã€‚

```terraform:apigateway.tf
module "todo_api_gateway" {
  source = "terraform-aws-modules/apigateway-v2/aws"

  name          = "${var.project_name}-api"
  protocol_type = "HTTP"
  description   = "API for managing a ToDo list"

  cors_configuration = {
    allow_methods = ["*"]
    allow_origins = ["*"]
    allow_headers = ["content-type", "x-amz-date", "authorization", "x-api-key", "x-amz-security-token", "x-amz-user-agent"]
  }

  routes = {
    "POST /create" = {
      integration = {
        type            = "AWS_PROXY"
        subtype         = "StepFunctions-StartExecution" # ã“ã“ãŒé‡è¦ï¼
        credentials_arn = aws_iam_role.api_gateway_role.arn

        request_parameters = {
          StateMachineArn = module.todo_sfn.state_machine_arn
          Input = jsonencode({
            operation = "create",
            payload   = "$request.body" # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£å…¨ä½“ã‚’payloadã«
          })
        }

        payload_format_version = "1.0"
        timeout_milliseconds   = 12000
      }
    }

    "GET /get" = {
      integration = {
        type            = "AWS_PROXY"
        subtype         = "StepFunctions-StartExecution" # ã“ã“ãŒé‡è¦ï¼
        credentials_arn = aws_iam_role.api_gateway_role.arn

        request_parameters = {
          StateMachineArn = module.todo_sfn.state_machine_arn
          Input = jsonencode({
            operation = "getTodo",
            payload   = "$request.body" # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£å…¨ä½“ã‚’payloadã«
          })
        }

        payload_format_version = "1.0"
        timeout_milliseconds   = 12000
      }
    }
  }

  stage_name = var.stage_name
  tags       = var.tags
}

# API GatewayãŒStep Functionsã‚’å‘¼ã³å‡ºã™ãŸã‚ã®IAMãƒ­ãƒ¼ãƒ«
resource "aws_iam_role" "api_gateway_role" {
  name = "api-gateway-role"
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect    = "Allow"
      Principal = { Service = "apigateway.amazonaws.com" }
      Action    = "sts:AssumeRole"
    }]
  })
  tags = var.tags
}

resource "aws_iam_role_policy" "api_gateway_policy" {
  name = "api-gateway-policy"
  role = aws_iam_role.api_gateway_role.id
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect   = "Allow"
      Action   = "states:StartExecution"
      Resource = [module.todo_sfn.state_machine_arn]
    }]
  })
}
```

`terraform-aws-modules/apigateway-v2/aws`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
ãƒ«ãƒ¼ãƒˆå®šç¾©ã®ä¸­ã«ã‚ã‚‹`integration`è¨­å®šãŒæœ€ã‚‚é‡è¦ã§ã™ã€‚

-   `type`: `AWS_PROXY` ã‚’æŒ‡å®šã—ã¾ã™ã€‚
-   `subtype`: `StepFunctions-StartExecution` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€é€£æºå…ˆãŒStep Functionsã®å®Ÿè¡Œã§ã‚ã‚‹ã“ã¨ãŒç¤ºã•ã‚Œã¾ã™ã€‚
-   `request_parameters`:
    -   `StateMachineArn`: å‘¼ã³å‡ºã™ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®ARNã‚’æŒ‡å®šã—ã¾ã™ã€‚
    -   `Input`: ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã«æ¸¡ã™å…¥åŠ›ï¼ˆJSONï¼‰ã‚’å®šç¾©ã—ã¾ã™ã€‚ã“ã“ã§`operation`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®å†…å®¹ã‚’`payload`ã«å…¥ã‚Œã‚‹ã“ã¨ã§ã€å¾Œç¶šã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ãŒå‡¦ç†ã‚’åˆ†å²ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€API GatewayãŒStep Functionsã®`StartExecution`ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®IAMãƒ­ãƒ¼ãƒ«ã¨ãƒãƒªã‚·ãƒ¼ã‚‚å¿˜ã‚Œãšã«ä½œæˆã—ã¾ã™ã€‚

## ã¾ã¨ã‚

ä»Šå›ã¯ã€Lambdaã‚’ä½¿ã‚ãšã«API Gatewayã¨Step Functionsã‚’ç›´æ¥é€£æºã•ã›ã‚‹æ§‹æˆã‚’Terraformã§æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

å˜ç´”ãªãƒ­ã‚¸ãƒƒã‚¯ã‚„AWSã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ã‚ã‚Œã°ã€ã“ã®æ§‹æˆã¯éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã‹ã¤å¼·åŠ›ã§ã™ã€‚Lambdaã®ç®¡ç†ã‹ã‚‰è§£æ”¾ã•ã‚Œã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«é›†ä¸­ã§ãã‚‹ãƒ¡ãƒªãƒƒãƒˆã¯å¤§ãã„ã¨æ„Ÿã˜ã¾ã™ã€‚
