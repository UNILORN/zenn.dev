---
title: "Windows11 + WSL2 (Ubuntu22.04) ã®NVIDIA GPUã«ã¤ã„ã¦ã€‚ã¨nvidia-dockerã‚’ã™ã“ã—"
emoji: "ğŸ‘€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nvidia", "wsl", "windows", "nvidiadocker"]
published: true
---

WSL2(Widnwos Subsystem for Linux)ã¯æ•°å¹´å‰ã¨æ¯”ã¹ã¦æ ¼æ®µã¨è‰¯ããªã‚Šã¾ã—ãŸã­ã€‚

Windowsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‹ã‚‰WSL2ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸéš›ã«`nvidia-smi` ã‚’WSL2ã§ä½¿ã†ã¾ã§ã‚’è¨˜äº‹ã§æ›¸ã“ã†ã¨ã—ã¾ã—ãŸã€‚

## çµæœ

**ãƒ›ã‚¹ãƒˆå´ã«ãƒ‰ãƒ©ã‚¤ãƒã‚’å…¥ã‚ŒãŸã‚‰å‹æ‰‹ã«WSL2ã«nvidia-smiãŒå…¥ã£ã¦ã„ã¦ã€æ™®é€šã«ä½¿ãˆãŸã€‚**

ğŸ˜²ğŸ˜²ğŸ˜²ğŸ˜²ğŸ˜²

![](https://storage.googleapis.com/zenn-user-upload/b50e38a698fa-20220604.png)

## ãŠã¾ã‘

ã‚ã¾ã‚Šã«ã‚‚ç´ ã£æ°—ãªã‹ã£ãŸã®ã§ã€nvidia-dockerã‚’WSL2å´ã®DockerEngineã«nvidia-dockerã‚’å»ºã¦ã¦nvidia-smiãŒå®Ÿè¡Œå‡ºæ¥ã‚‹ã‹è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

### dockerã‚’å…¥ã‚Œã‚‹


![](https://storage.googleapis.com/zenn-user-upload/39829706ed51-20220604.png)

ã¾ã ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã°ã£ã‹ã‚Šã ã£ãŸã®ã§DockerãŒå…¥ã£ã¦ã„ã¾ã›ã‚“ã€‚
ã¨ã‚Šã‚ãˆãš[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.docker.com/engine/install/ubuntu/)ã®é€šã‚Šã«å…¥ã‚Œã¦ã¿ã¾ã™ã€‚

```bash
 ! î‚° ~ î‚° sudo apt-get remove docker docker-engine docker.io containerd runc                                                                                          Sat 04 Jun 2022 11:32:45 PM JSTReading package lists... Done
Building dependency tree... Done
Reading state information... Done
E: Unable to locate package docker-engine
 ! î‚° ~ î‚° sudo apt-get update                                                                                                                                 161ms î‚³ Sat 04 Jun 2022 11:32:49 PM JSTHit:1 http://archive.ubuntu.com/ubuntu jammy InRelease
Get:2 http://security.ubuntu.com/ubuntu jammy-security InRelease [110 kB]
Get:3 http://archive.ubuntu.com/ubuntu jammy-updates InRelease [109 kB]
Get:4 http://security.ubuntu.com/ubuntu jammy-security/main amd64 Packages [130 kB]
Get:5 http://archive.ubuntu.com/ubuntu jammy-backports InRelease [99.8 kB]
Get:6 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 Packages [238 kB]
Get:7 http://security.ubuntu.com/ubuntu jammy-security/main Translation-en [34.0 kB]
Get:8 http://security.ubuntu.com/ubuntu jammy-security/main amd64 c-n-f Metadata [2,172 B]
Get:9 http://security.ubuntu.com/ubuntu jammy-security/universe amd64 Packages [59.5 kB]
Get:10 http://security.ubuntu.com/ubuntu jammy-security/universe amd64 c-n-f Metadata [960 B]
Get:11 http://archive.ubuntu.com/ubuntu jammy-updates/main Translation-en [59.5 kB]
Get:12 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 c-n-f Metadata [3,980 B]
Get:13 http://archive.ubuntu.com/ubuntu jammy-updates/restricted amd64 Packages [140 kB]
Get:14 http://archive.ubuntu.com/ubuntu jammy-updates/restricted Translation-en [21.4 kB]
Get:15 http://archive.ubuntu.com/ubuntu jammy-updates/restricted amd64 c-n-f Metadata [460 B]
Get:16 http://archive.ubuntu.com/ubuntu jammy-updates/universe amd64 Packages [102 kB]
Get:17 http://archive.ubuntu.com/ubuntu jammy-updates/universe Translation-en [34.2 kB]
Get:18 http://archive.ubuntu.com/ubuntu jammy-updates/universe amd64 c-n-f Metadata [1,848 B]
Get:19 http://archive.ubuntu.com/ubuntu jammy-backports/universe amd64 Packages [2,036 B]
Get:20 http://archive.ubuntu.com/ubuntu jammy-backports/universe Translation-en [7,012 B]
Get:21 http://archive.ubuntu.com/ubuntu jammy-backports/universe amd64 c-n-f Metadata [212 B]
Fetched 1,157 kB in 2s (673 kB/s)
Reading package lists... Done
 ~ î‚° sudo apt-get install \                                                                                                                                 3849ms î‚³ Sat 04 Jun 2022 11:33:02 PM JST
             ca-certificates \
             curl \
             gnupg \
             lsb-release
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
ca-certificates is already the newest version (20211016).
ca-certificates set to manually installed.
gnupg is already the newest version (2.2.27-3ubuntu2).
gnupg set to manually installed.
lsb-release is already the newest version (11.1.0ubuntu4).
lsb-release set to manually installed.
curl is already the newest version (7.81.0-1ubuntu1.2).
curl set to manually installed.
0 upgraded, 0 newly installed, 0 to remove and 27 not upgraded.
 ~ î‚° sudo mkdir -p /etc/apt/keyrings                                                                                                                         237ms î‚³ Sat 04 Jun 2022 11:33:21 PM JST ~ î‚° curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg                                                    Sat 04 Jun 2022 11:33:40 PM JST
 ~ î‚° echo \                                                                                                                                                          Sat 04 Jun 2022 11:33:45 PM JST
           "deb [arch=(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
       (lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
 ~ î‚° sudo apt-get update                                                                                                                                             Sat 04 Jun 2022 11:34:03 PM JST
E: Malformed entry 1 in list file /etc/apt/sources.list.d/docker.list ([option] not assignment)
E: The list of sources could not be read.
```

????

Fishshellç”¨ã«æ›¸ãæ›ãˆãŸã®ãŒãƒ€ãƒ¡ã ã£ãŸã‚ˆã†ã§ã™ã€‚

```bash
cat  /etc/apt/sources.list.d/docker.list                                                                                                                       
deb [arch=(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu   (lsb_release -cs) stable
```

![](https://storage.googleapis.com/zenn-user-upload/22261cb51e1f-20220604.png)

ãã‚Œãã‚Œã‚³ãƒãƒ³ãƒ‰ã‚’å©ã„ã¦å‡ºåŠ›ã•ã‚ŒãŸç‰©ã«æ›¸ãæ›ãˆã¾ã—ãŸã€‚ã¡ã‚ƒã‚“ã¨é€šã£ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã­ã€‚

æœ€å¾Œã«Docker Engineã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin                                                                       1206ms î‚³ Sat 04 Jun 2022 11:37:39 PM JST
Reading package lists... Done
Building dependency tree... Done
...
```

Dockerç¢ºèªï¼ï¼

```bash
docker ps                                                                                       
Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?

systemctl status docker
System has not been booted with systemd as init system (PID 1). Can't operate.
Failed to connect to bus: Host is down
```

ãã‚Šã‚ƒãã†ã§ã™ã‚ˆã­ã€‚

[ã“ã¡ã‚‰ã®è¨˜äº‹](https://qiita.com/blueskyarea/items/ef262768c8f8f2ebe990)ã‚’å‚è€ƒã« init.d ã‚’è¨­å®šã—ã¦ã¿ã¾ã™ã€‚

```bash
$ cat <<EOF >> ~/.bashrc
# For Docker service start
sudo /etc/init.d/docker start
EOF
```

![](https://storage.googleapis.com/zenn-user-upload/d0947b4e9e78-20220604.png)

ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”

```
tail -f /var/log/docker.log
...çœç•¥
failed to start daemon: Error initializing network controller: error obtaining controller instance: unable to add return rule in DOCKER-ISOLATION-STAGE-1 chain:  (iptables failed: iptables --wait -A DOCKER-ISOLATION-STAGE-1 -j RETURN: iptables v1.8.7 (nf_tables):  RULE_APPEND failed (No such file or directory): rule in chain DOCKER-ISOLATION-STAGE-1
 (exit status 4))
```

ãªã‚‹ã»ã©ã‚ã‹ã‚‰ã‚“ã€‚

[WSLã®ãƒã‚°ã£ã½ã„](https://bugs.launchpad.net/ubuntu-wsl-integration/+bug/1908539)äº‹ãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã—ãŸã®ã§ã€ã¨ã‚Šã‚ãˆãšæš«å®šå¯¾å¿œã—ã¾ã™ã€‚

```bash
sudo update-alternatives --config iptables                                                                                                                                                 
There are 2 choices for the alternative iptables (providing /usr/sbin/iptables).

  Selection    Path                       Priority   Status
------------------------------------------------------------
* 0            /usr/sbin/iptables-nft      20        auto mode
  1            /usr/sbin/iptables-legacy   10        manual mode
  2            /usr/sbin/iptables-nft      20        manual mode

Press <enter> to keep the current choice[*], or type selection number: 1
update-alternatives: using /usr/sbin/iptables-legacy to provide /usr/sbin/iptables (iptables) in manual mode
```

![](https://storage.googleapis.com/zenn-user-upload/1221e3e1e9e9-20220604.png)

Dockerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸã€‚

### Nvidia Doker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã™ã‚‹

Nvidia Dockerã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®runtimeã‚’nvidiaã«å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

[Nvidiaå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/user-guide.html)

ã‚’è¦‹ãªãŒã‚‰ã‚„ã£ã¦è¡Œãã¾ã™ã€‚ãŒã€ã¨ã‚Šã‚ãˆãš`nvidia-docker2`ã§å…¥ã‚Œã‚‰ã‚Œã‚‹ã£ã½ã„ã“ã¨ãŒæ›¸ã„ã¦ã‚ã‚‹ã®ã§

[Container Toolkit - Install Guide : Nvidiaå…¬å¼](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html)

ã®æ–¹ã‚’è¦‹ãªãŒã‚‰ã‚„ã£ã¦ãã¾ã™ã€‚

```bash
distribution=$(. /etc/os-release;echo $ID$VERSION_ID) \
      && curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
      && curl -s -L https://nvidia.github.io/libnvidia-container/$distribution/libnvidia-container.list | \
            sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
            sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list

deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://nvidia.github.io/libnvidia-container/stable/ubuntu18.04/$(ARCH) /
#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://nvidia.github.io/libnvidia-container/experimental/ubuntu18.04/$(ARCH) /
```

`ubuntu18.04` ğŸ¤”

> For distribution values of ubuntu20.04 or ubuntu22.04 the file will contain ubuntu18.04 URLs

ğŸ˜Œ

```bash
sudo apt-get update
sudo apt-get install -y nvidia-docker2
sudo /etc/init.d/docker restart
```


ç„¡äº‹æˆåŠŸã—ã¾ã—ãŸã€‚

### å‹•ä½œç¢ºèª

å…¬å¼é€šã‚Šã«é…å¸ƒã•ã‚Œã¦ã„ã‚‹Docker Imageã‹ã‚‰nvidia-smiã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```
$ sudo docker run --rm --gpus all nvidia/cuda:11.0.3-base-ubuntu20.04 nvidia-smi
Unable to find image 'nvidia/cuda:11.0.3-base-ubuntu20.04' locally
11.0.3-base-ubuntu20.04: Pulling from nvidia/cuda
d5fd17ec1767: Pull complete
ea7643e57386: Pull complete
622a04926279: Pull complete
18fcb7509e42: Pull complete
21e5db7c1fa2: Pull complete
Digest: sha256:1db9418b1c9070cdcbd2d0d9980b52bd5cd20216265405fdb7e089c7ff96a494
Status: Downloaded newer image for nvidia/cuda:11.0.3-base-ubuntu20.04
Sat Jun  4 15:02:44 2022
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 510.68.02    Driver Version: 512.95       CUDA Version: 11.6     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  NVIDIA GeForce ...  On   | 00000000:0A:00.0  On |                  N/A |
|  0%   37C    P8    18W / 290W |   1900MiB /  8192MiB |     11%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+

$ sudo docker run --rm --gpus all nvidia/cuda:11.0.3-base-ubuntu20.04 nvidia-smi -L
GPU 0: NVIDIA GeForce RTX 3070 Ti (UUID: GPU-

```

æˆåŠŸã§ã™ã€‚

## æœ€å¾Œã«

WSL2 ã§ã€€nvidia-docker ã‚’å®Ÿè¡Œã™ã‚‹è¨˜äº‹ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸãŒã€WSLã§ã“ã“ã¾ã§å‡ºæ¥ã‚Œã°WindowsãŒã‚ã‚Œã°ä½•ã§ã‚‚å‡ºæ¥ã¾ã™ã­ã€‚
é–‹ç™ºã®ã—ã‚„ã™ã•ãªã©ã€Windowsã®é€²æ­©ãŒã™ã”ã„ã¨æ„Ÿã˜ã¾ã—ãŸã€‚

ä»•äº‹ã§ã¯MacbookProã‚’ä½¿ã£ã¦ã¾ã™ãŒã€armæ©Ÿã¨ã—ã¦ã®Macã¨amd64æ©Ÿã¨ã—ã¦ã®Windowsä¸¡æ–¹ã‚’ä¸Šæ‰‹ãåˆ©ç”¨ã—ã¦é–‹ç™ºã—ã¦ã„ããŸã„ãªã¨æ€ã„ã¾ã™ã€‚
