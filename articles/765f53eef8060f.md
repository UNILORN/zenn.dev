---
title: "Socketé€šä¿¡ã¯APIGateway+Lambda+DynamoDBã«ä»»ã›ã‚ˆã†ï¼ˆ2ï¼‰"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "apigateway", "lambda", "DynamoDB", "terraform", "go"]
published: false
---

å‰å›ã®è¨˜äº‹ã®ç¶šãã§ã™ã€‚

ä»Šå›ã¯API Gatewayã«JWTèªè¨¼ã‚’å°å…¥ã—ã¦èªè¨¼æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚

## API Gatewayã®èªè¨¼ã«ã¤ã„ã¦

AWS API Gatewayã¨è¨€ãˆã° Cognitoã«ã‚ˆã‚‹èªè¨¼ã§ã€ã‚ˆãåˆ©ç”¨ã•ã‚Œã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

https://dev.classmethod.jp/articles/api-gateway-cognito-authorizer/

ãŸã ã€WebSocketã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€ã¤ã®ãŸã‚ã«Cognitoã‚’å°å…¥ã™ã‚‹ã®ã¯éå¸¸ã«ã‚³ã‚¹ãƒ‘ãŒæ‚ªãã€è»½ãèªè¨¼ã‚’å…¥ã‚ŒãŸã„å ´åˆã«ã¯å‘ã„ã¦ã„ã¾ã›ã‚“ã€‚

æ‰‹è»½ã«èªè¨¼ã‚’å®Ÿç¾ã—ãŸã„ã€‚ã€‚ ãã†ã„ã£ãŸã¨ãã«ä¾¿åˆ©ãªã®ãŒJWTèªè¨¼ã§ã™ã€‚

## JWTèªè¨¼ã‚’ä½¿ã†

JWTèªè¨¼ã«ã¤ã„ã¦ã¯æ·±ãè§£èª¬ã—ã¾ã›ã‚“ãŒã€å…¬é–‹éµãƒ»ç§˜å¯†éµã®éµãƒšã‚¢ã®ã†ã¡ã€ç§˜å¯†éµã‚’ä½¿ã£ã¦ç‰¹å®šã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«ç½²åã‚’ãŠã“ãªã„ã€å…¬é–‹éµã§è§£éŒ ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šèªè¨¼ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

```mermaid

flowchart TB
  node_1["Backend Server"]
  node_2["Lambda"]
  node_3(["User"])
  node_4{{"éµãƒšã‚¢"}}
  node_3 --"JWTè¦æ±‚: â€»åˆ¥èªè¨¼ã«ã¦èªè¨¼æ¸ˆã¿"--> node_1
  node_1 --"JWTå–å¾—"--> node_3
  node_3 --"JWTã‚’ã¤ã‘ã¦Request"--> node_2
  node_4 -."ç½²å".-> node_1
  node_4 -."æ¤œè¨¼".-> node_2

```

éµãƒšã‚¢ã®ã†ã¡ã€å…¬é–‹éµã‚’Lambdaã«ç™»éŒ²ã—ã¦ãŠãäº‹ã§ç½²åã•ã‚ŒãŸTokenã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

## JWTèªè¨¼ã‚’è¡Œã†ç‚ºã«éµãƒšã‚¢ä½œæˆã¨Lambdaã¸ã®ã‚¢ã‚¿ãƒƒãƒã‚’è¡Œã†

Lambdaã®ä½œæˆã¾ã§å®Ÿæ–½ã—ã¦ã—ã¾ã£ã¦ã„ã¾ã™ãŒã€ç’°å¢ƒå¤‰æ•°ã«å…¬é–‹éµã‚’ç™»éŒ²ã™ã‚‹ã¨ã“ã‚ã¾ã§è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

```tf
# API Gateway ã«å¯¾ã—ã¦JWTèªè¨¼ã‚’ã™ã‚‹ç‚ºã®éµãƒšã‚¢ä½œæˆ

# å…¬é–‹éµã¨ç§˜å¯†éµã®ç”Ÿæˆ
resource "tls_private_key" "chat_websocket_handler_connect_key" {
  algorithm = "RSA"
  rsa_bits  = 2048
}

resource "tls_self_signed_cert" "chat_websocket_handler_connect_cert" {
  private_key_pem = tls_private_key.chat_websocket_handler_connect_key.private_key_pem

  subject {
    common_name  = "${local.lambda_name}-key"
    organization = "UNILORN"
  }

  validity_period_hours = 87600 # 10 year

  allowed_uses = [
    "key_encipherment",
    "digital_signature",
    "server_auth",
  ]
}

# å…¬é–‹éµã‚’å–å¾—
data "tls_public_key" "chat_websocket_handler_connect_public_key" {
  private_key_pem = tls_private_key.chat_websocket_handler_connect_key.private_key_pem
}

# ç”Ÿæˆã—ãŸéµã‚’AWS Secrets Managerã«ä¿å­˜
resource "aws_secretsmanager_secret" "chat_websocket_handler_connect_key" {
  name = "${local.lambda_name}-key"
}

# Secret Manager versionä½œæˆ
resource "aws_secretsmanager_secret_version" "chat_websocket_handler_connect_key" {
  secret_id     = aws_secretsmanager_secret.chat_websocket_handler_connect_key.id
  secret_string = <<-EOT
  {
    "private_key": "${tls_private_key.chat_websocket_handler_connect_key.private_key_pem}",
    "public_key": "${data.tls_public_key.chat_websocket_handler_connect_public_key.public_key_pem}"
  }
  EOT
}

# Lambda Function
resource "aws_lambda_function" "chat_websocket_handler_connect" {
  depends_on = [
    aws_iam_role.chat_websocket_handler_connect_lambda_role,
    module.ecr
  ]
  function_name = local.lambda_name
  role          = aws_iam_role.chat_websocket_handler_connect_lambda_role.arn
  package_type  = "Image"
  image_uri     = "${local.ecr_registry}/${local.lambda_image_ecr_repository_name}:${var.api_gateway_websocket_connection_lambda_image_tag}"
  timeout       = 30

  environment {
    variables = {
      #
      # å…¬é–‹éµã‚’Lambdaã®ç’°å¢ƒå¤‰æ•°ã«ç™»éŒ²ã™ã‚‹
      #
      PUBLIC_KEY                         = data.tls_public_key.chat_websocket_handler_connect_public_key.public_key_pem
      DYNAMO_TABLE_NAME_CHAT_CONNECTIONS = aws_dynamodb_table.chat_connection.name
    }
  }
}

```

ã‚½ãƒ¼ã‚¹ä¸Šã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã«è¨˜è¼‰ã—ã¦ã„ã‚‹é€šã‚Šã§ã™ãŒã€éµãƒšã‚¢ã®ä½œæˆãªã©ã‚‚Terraformã§å®Ÿæ–½å‡ºæ¥ã¾ã™ã®ã§éå¸¸ã«ç°¡å˜ã«ç™»éŒ²ãŒã§ãã¦ã„ã¾ã™ã€‚
AWS Secret Managerã«ç™»éŒ²ã—ã¦ã„ã‚‹ã®ã§ã€åˆ¥é€”BackendServerã«é€ã‚ŠãŸã„å ´åˆã¯SecretManagerã‹ã‚‰å–å¾—ã—ã¦åˆ©ç”¨ã™ã‚‹äº‹ã«ãªã‚Šã¾ã™ã€‚

## JWTæ¤œè¨¼ - Golang

Lambdaã§ã¯Golangã‚’ç”¨ã„ã¦JWTã®æ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚
`PUBLIC_KEY` ç’°å¢ƒå¤‰æ•°ã«å…¬é–‹éµã‚’å…¥ã‚Œã¾ã—ãŸã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸ `tokenString` ã«åŸºã¥ã„ã¦æ¤œè¨¼ã—ã¾ã™ã€‚

Tokenã®æœ‰åŠ¹æœŸé™ã‚’Tokenå†…ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«å…¥ã‚Œã¦ã„ã‚‹ç‚ºã€æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ã‚‚åŒæ™‚ã«å®Ÿæ–½ã—ã¦ã„ã¾ã™ã€‚

```go
func verifyToken(tokenString string) error {
	pubPEM := os.Getenv("PUBLIC_KEY")

	// Parse PEM formatted public key
	block, _ := pem.Decode([]byte(pubPEM))
	if block == nil {
		return fmt.Errorf("failed to decode public key")
	}

	// Parse public key into x509 format
	pubKey, err := x509.ParsePKIXPublicKey(block.Bytes)
	if err != nil {
		return fmt.Errorf("failed to parse public key: %w", err)
	}

	// Ensure public key is in RSA format
	rsaPubKey, ok := pubKey.(*rsa.PublicKey)
	if !ok {
		return fmt.Errorf("public key is not in RSA format")
	}

	// Parse JWT token and verify signature
	token, err := jwt.Parse(tokenString, func(token *jwt.Token) (interface{}, error) {
		// Verify token signing method is RSA
		if _, ok := token.Method.(*jwt.SigningMethodRSA); !ok {
			return nil, fmt.Errorf("unexpected signing method: %v", token.Header["alg"])
		}
		return rsaPubKey, nil
	})

	if err != nil {
		return fmt.Errorf("failed to parse token or verify signature: %w", err)
	}

	if claims, ok := token.Claims.(jwt.MapClaims); ok {
		if exp, ok := claims["exp"].(float64); ok {
			if time.Now().Unix() > int64(exp) {
				return fmt.Errorf("token has expired")
			}
		}
	} else {
		return fmt.Errorf("invalid token claims")
	}


	return nil // Successfully verified signature
}
```

## JWTç½²å - PHP

![](https://storage.googleapis.com/zenn-user-upload/67d63a5c4896-20241114.png)

AWS Secret Manager ã‹ã‚‰PrivateKeyã‚’å‚ç…§ã—ã€JWTç½²åã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

ä»Šå›Backend Serverã§ã¯PHPã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã—ãŸã®ã§PHPã§è¨˜è¼‰ã—ã¾ã™ã€‚

```php
/**
 * Create a JWT token
 *
 * @param string $room_id Room identifier
 * @param int $issued_at Token issue timestamp
 * @param int $expired_at Token expiration timestamp
 * @return string JWT token
 * @throws RuntimeException If signing operation fails
 */
private function createJWT(string $room_id, int $issued_at, int $expired_at): string
{
        $private_key = config('jwt.private_key');
    if (empty($private_key)) {
        throw new RuntimeException('Private key is not configured');
    }

    // Create token header
    $header = json_encode([
        'typ' => 'JWT',
        'alg' => 'RS256'
    ], JSON_UNESCAPED_SLASHES);
    if ($header === false) {
        throw new RuntimeException('Failed to encode header');
    }

    // Create token payload
    $payload = json_encode([
        'sub' => $room_id,
        'iat' => $issued_at,
        'exp' => $expired_at
    ], JSON_UNESCAPED_SLASHES);
    if ($payload === false) {
        throw new RuntimeException('Failed to encode payload');
    }

    // Create unsigned token
    $unsignedToken = $this->base64UrlEncode($header) . '.' . $this->base64UrlEncode($payload);

    // Sign the token
    if (!openssl_sign($unsignedToken, $signature, $private_key, OPENSSL_ALGO_SHA256)) {
        throw new RuntimeException('Failed to sign token');
    }

    // Return complete JWT token
    return $unsignedToken . '.' . $this->base64UrlEncode($signature);
}

/**
 * Encode string to base64url format
 *
 * @param string $data Data to encode
 * @return string Base64url encoded string
 */
private function base64UrlEncode(string $data): string
{
    return rtrim(strtr(base64_encode($data), '+/', '-_'), '=');
}
```

ã©ã®è¨€èªã§ã‚‚å¤§ä½“ä¼¼ãŸã‚ˆã†ãªå‡¦ç†ã«ãªã‚Šã¾ã™ãŒã€JWTã«ã‚ˆã‚‹ç½²åã‚’å®Ÿæ–½ã—ã¦ã„ã¾ã™ã€‚

`sub` ã‚„ `iat`, `exp` ã«æ¨©é™ä»˜ä¸ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ä»Šå›ã¯ç‰¹å®šã®Roomã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’å®Ÿæ–½ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¨ãªã‚‹ãŸã‚ã€ `sub` ã«ã¯RoomIDã‚’å…¥ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

## ã¾ã¨ã‚

JWTèªè¨¼ã‚’ç”¨ã„ã¦ã€API Gatewayã‚’çµŒç”±ã—ã¦Lambdaã«ãƒ•ãƒ«ã‚¢ã‚¯ã‚»ã‚¹å‡ºæ¥ã¦ã—ã¾ã†çŠ¶æ…‹ã‚’æ¨©é™ã®ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ã®ã¿ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹æ–¹æ³•ã‚’è¨˜è¼‰ã—ã¾ã—ãŸã€‚
é•ã£ãŸè¨€èªã§ã‚‚å¯¾å¿œã—ã¦ã„ã‚‹ãŸã‚ã€éå¸¸ã«æ‰±ã„ã‚„ã™ã„ã‚‚ã®ã¨ãªã£ã¦ã„ã¾ã™ã€‚

## æ¬¡å›: DynamoDBã«ã‚ˆã‚‹ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†

æ¬¡ã«ã€WebSocketAPIã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ããŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å¯¾ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ã’ã‚‹ãŸã‚ã«ã€ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã‚’ã—ãªãã¦ã¯ã„ã‘ãªã„ç‚º
ãã‚Œã‚‰ã‚’DynamoDBã‚’ç”¨ã„ã¦ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã‚’å®Ÿæ–½ã—ã¦ã¿ã¾ã™ã€‚

