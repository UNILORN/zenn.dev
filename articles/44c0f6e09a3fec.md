---
title: "Lambdaã‚’VPCã«å…¥ã‚Œã¦RDSã¨æ¥ç¶šã™ã‚‹"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "terraform", "lambda", "RDS"]
published: false
---

Lambdaã‹ã‚‰RDSã¸é€šä¿¡ã™ã‚‹ç‚ºã«ã¯ã€VPCã¸ã®ç´ä»˜ã‘ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€VPCã¨Subnetã«ç´ä»˜ã‘ãŸã¨ã—ã¦ã‚‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚Šã¾ã™ã‹ã‚‰
ãã‚Œãã‚Œã«è¨­å®šã‚’ã—ã¦ã‚ã’ãªã„ã¨æ¥ç¶šãŒå‡ºæ¥ãªã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```mermaid

flowchart TB
    subgraph VPC

subgraph PrivateSubnet
    node_1["Lambda"]
    node_3(["Security Group"])
    node_2["RDS"]
    node_4(["Security Group"])
    node_5((" "))
end
   
    node_1 --> node_3
    node_3 --> node_5
    node_5 --> node_4
    node_4 --> node_2
  end

```

## æ™®é€šã«ä½œã‚‹ã¨

Lambdaã‚’ä»¥ä¸‹ã®Terraformã®ã‚ˆã†ã«æ™®é€šã«ä½œæˆã™ã‚‹ã¨VPCã«ã™ã‚‰ç´ä»˜ã„ã¦ã„ãªã„çŠ¶æ…‹ã§ä½œæˆã•ã‚Œã¾ã™ã€‚
ãã®å ´åˆã€é€šå¸¸æ¥ç¶šãŒå‡ºæ¥ã¾ã›ã‚“ã€‚

```mermaid

flowchart TB
     node_1["Lambda"]
    subgraph VPC

subgraph PrivateSubnet
    node_2["RDS"]
    node_4(["Security Group"])
end
    node_5((" "))
    node_2 --> node_4
    node_4 --> node_5
    
  end

  node_1 -."æ¥ç¶šä¸å¯".-x node_5
```

```tf
resource "aws_lambda_function" "lambda_function" {
  function_name = local.lambda_function_name
  role          = aws_iam_role.lambda_role.arn
  package_type  = "Image"
  image_uri     = "${local.ecr_registry}/${local.ecr_repository_name}:${local.lambda_image_tag}"
  timeout       = local.lambda_timeout
  memory_size   = local.lamnda_memory_limit
}
```

## VPCã«å…¥ã‚Œã‚‹

æ¬¡ã«VPCã«ç´ä»˜ã‘ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã™ã‚‹ã¨ã€VPCã«å…¥ã£ã¦ãã‚Œã¾ã™ã€‚

ä»Šå›ã¯RDSã¨åŒã˜Subnetã«å…¥ã‚Œã‚‹äº‹ã¨ã—ã¾ã™ã€‚åˆ¥ã®Subnetã«å…¥ã‚Œã¦ã‚‚è‰¯ã„ã§ã™ãŒãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ãªã©ã®è¨­å®šãŒå¿…è¦ã«ãªã‚‹ã®ã§ã€å¤§è¦æ¨¡ãªã‚·ã‚¹ãƒ†ãƒ ã§ç„¡ã„å ´åˆã¯åŒã˜Subnetã«å…¥ã‚Œã¦ã—ã¾ã£ã¦ã‚‚è‰¯ã„ã§ã—ã‚‡ã†ã€‚


```mermaid

flowchart TB
    subgraph VPC

subgraph PrivateSubnet
    node_1["Lambda"]
    node_3(["Security Group"])

    node_2["RDS"]
    node_4(["Security Group"])
end
    node_1 --> node_3
    node_2 --> node_4
  end
```

```tf
# Lambda Function
resource "aws_lambda_function" "lambda_function" {
  function_name = local.lambda_function_name
  role          = aws_iam_role.lambda_role.arn
  package_type  = "Image"
  image_uri     = "${local.ecr_registry}/${local.ecr_repository_name}:${local.lambda_image_tag}"
  timeout       = local.lambda_timeout
  memory_size   = local.lamnda_memory_limit

  dynamic "vpc_config" {
    for_each = can(var.connect_lambda_rds.enabled) ? [1] : []

    content {
      subnet_ids         = var.connect_lambda_rds.subnet_ids
      security_group_ids = [aws_security_group.lambda_sg[0].id]
    }
  }
}

resource "aws_security_group" "lambda_sg" {
  count = var.connect_lambda_rds.enabled ? 1 : 0

  name_prefix = "${local.lambda_function_name}-lambda-sg-"
  vpc_id      = var.connect_lambda_rds.vpc_id
}
```

:::message

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã—ã¦ã„ã‚‹éƒ½åˆã§ONOFFå‡ºæ¥ã‚‹ã‚ˆã†ã«æ”¹è‰¯ã•ã‚Œã¦ã„ã¾ã™ã€‚

:::

ã“ã®çŠ¶æ…‹ã ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã§æ‹’å¦ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã®ã§ã€é€šä¿¡ã¯å‡ºæ¥ã¾ã›ã‚“ã€‚

Lambdaã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã¸ç§»å‹•ã—ã¦ã‚‚RDSæ¥ç¶šæƒ…å ±ã«ä½•ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚

![](https://storage.googleapis.com/zenn-user-upload/8e7a13e3400f-20241106.png)

## SecurityGroupã‚’è¨­å®šã™ã‚‹

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®è¨­å®šã¯ã€RDSå´ã¨Lambdaå´ã®åŒæ–¹ã«è¨­å®šãŒå¿…è¦ã§ã™ã€‚

ä»Šå›RDSã¯Postgresã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã®ã§ 5432ãƒãƒ¼ãƒˆ ã‚’åŒæ–¹ã«è¨±å¯ã—ã¦ä¸Šã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```mermaid

flowchart TB
    subgraph VPC

subgraph PrivateSubnet
    node_1["Lambda"]
    node_3(["Security Group"])
    node_2["RDS"]
    node_4(["Security Group"])
    node_5((" "))
end
   
    node_1 --> node_3
    node_3 --"egress: 5432"--> node_5
    node_5 --"ingress: 5432"--> node_4
    node_4 --> node_2
  end

```


```tf
# Lambda Function
resource "aws_lambda_function" "lambda_function" {
  function_name = local.lambda_function_name
  role          = aws_iam_role.lambda_role.arn
  package_type  = "Image"
  image_uri     = "${local.ecr_registry}/${local.ecr_repository_name}:${local.lambda_image_tag}"
  timeout       = local.lambda_timeout
  memory_size   = local.lamnda_memory_limit

  dynamic "vpc_config" {
    for_each = can(var.connect_lambda_rds.enabled) ? [1] : []

    content {
      subnet_ids         = var.connect_lambda_rds.subnet_ids
      security_group_ids = [aws_security_group.lambda_sg[0].id]
    }
  }
}

resource "aws_security_group" "lambda_sg" {
  count = var.connect_lambda_rds.enabled ? 1 : 0

  name_prefix = "${local.lambda_function_name}-lambda-sg-"
  vpc_id      = var.connect_lambda_rds.vpc_id

  egress {
    from_port       = 5432
    to_port         = 5432
    protocol        = "tcp"
    security_groups = var.connect_lambda_rds.rds_security_group_ids
  }
}

# RDS ã¸ã®ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«ã§Lambdaã‚’è¨±å¯
resource "aws_security_group_rule" "rds_sg" {
  for_each = toset(var.connect_lambda_rds.rds_security_group_ids)

  type                     = "ingress"
  from_port                = 5432
  to_port                  = 5432
  protocol                 = "tcp"
  source_security_group_id = aws_security_group.lambda_sg[0].id
  security_group_id        = each.value
}

```

RDSå´ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã¯åˆ¥é€”ä½œæˆæ¸ˆã¿ã®ãŸã‚ã€ `aws_security_group_rule` ã§ãƒ«ãƒ¼ãƒ«ã®ã¿ã®è¿½åŠ ã‚’ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã§ã€åŒæ–¹ã®æ¥ç¶šãŒè¨±å¯ã•ã‚ŒãŸãŸã‚ã€RDSã¸ã®æ¥ç¶šãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

## è£œè¶³

ä»Šã¯ç›´æ¥RDSã¨æ¥ç¶šã‚’ã—ã¦ã„ã¾ã™ãŒã€API Gatewayãªã©ã§è†¨å¤§ãªæ¥ç¶šé‡ãŒè¦‹è¾¼ã¾ã‚Œã‚‹å ´åˆã¯RDSã¸ã®è² è·ã‚’è€ƒæ…®ã—ã¦ `RDS Proxy` ã®æ¤œè¨ã‚’ã—ã¾ã—ã‚‡ã†ã€‚
`RDS Proxy` ã‚’åˆ©ç”¨ã™ã‚‹äº‹ã§ã€å¢—å¤§ã™ã‚‹RDSã¸ã®æ¥ç¶šæ•°ã«ã‚ˆã‚‹è² è·ãŒè»½æ¸›ã•ã‚Œã¾ã™ã€‚

https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/rds-proxy.html

RDS Proxyã¯åˆ¥é€”æ–™é‡‘ãŒç™ºç”Ÿã™ã‚‹ãŸã‚ã€1æ—¥ã«æ•°å›ç¨‹åº¦ã®æ¥ç¶šã—ã‹ç„¡ã„ã‚ˆã†ãªLambdaã®å ´åˆã¯ç›´æ¥æ¥ç¶šã—ã¦ã—ã¾ã£ã¦ã‚‚å¤§ããªå•é¡Œã«ã¯ãªã‚‰ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
é©å®œã”åˆ¤æ–­ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

## æœ€å¾Œã«

Lambdaã‹ã‚‰RDSã«æ¥ç¶šã™ã‚‹ã®ã¯ã‚ã¾ã‚Šæœ›ã¾ã—ããªã„ã‚ˆã†ãªæ°—ãŒã—ã¾ã™ãŒã€ã€1æ—¥æ•°å›ç¨‹åº¦ã®ãƒãƒƒãƒå‡¦ç†ãªã©ãã“ã¾ã§é‡ãŸããªã„å‡¦ç†ã‚’ã‚µãƒ¼ãƒãƒ¬ã‚¹ã§å®Ÿæ–½ã—ãŸã„å ´åˆãªã©ã«ã¯æ´»ç”¨å‡ºæ¥ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ç§ã¯DynamoDBãªã©ã§çµ‚ã‚ã‚‰ã›ã¦ã—ã¾ã†äº‹ãŒå¤šã„ã§ã™ãŒã€NoSQLã¯ãã‚Œã¯ãã‚Œã§è‹¦åŠ´ãŒå¾…ã£ã¦ã‚‹äº‹ã‚‚å¤šã„ã®ã§ã€é©å®œçŠ¶æ³ã«åˆã‚ã›ã¦RDBMSã¨ä½µç”¨æ´»ç”¨ã™ã‚‹ã¨è‰¯ã„ã®ã‹ãªã¨æ€ã„ã¾ã™ã€‚

