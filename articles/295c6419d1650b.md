---
title: "ã€Terraformã€‘AWS S3ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«StepFunctionã§Slackã¨Teamsã«é€šçŸ¥ã™ã‚‹"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["terraform", "aws", "s3", "stepfunction"]
published: true
---

S3ã«Jsonãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã‚‹ã ã‘ã§ã€ãã®Jsonãƒ‡ãƒ¼ã‚¿å†…å®¹ã«å¿œã˜ã¦Slackã‚„Teamsã«é€šçŸ¥ã—ãŸã„ï¼ï¼

ã¿ãŸã„ãªã‚±ãƒ¼ã‚¹ã«å½¹ç«‹ã¤è¨˜äº‹ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

## å…¨ä½“æ§‹æˆå›³

```mermaid

flowchart TB
  node_1["S3"]
  node_2["SQS"]
  node_3["Eventbridge Pipe"]
  

  node_1 --> node_2
  node_2 --> node_3
  node_3 --> node_4
  

subgraph sf["Step Function"]
    node_4["S3 Get Object"]
    node_5["Teams Notify"]
    node_6["Skack Notify"]
    
end

node_4 --> node_5
  node_4 --> node_6
```

è©³ç´°ã«ã‹ãã¨ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ãƒ­ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚

- S3ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ãƒƒã‚¯ã™ã‚‹
- SQSã«æ¸¡ã™
- SQSã‹ã‚‰EventBridgeã«æµã™
- EventBridgeã‹ã‚‰StepFunctionã‚’èµ·å‹•ã™ã‚‹
- S3ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹
- S3ã‹ã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã—Jsonã§å±•é–‹ã™ã‚‹
- ã‚¨ãƒ©ãƒ¼ã‚’åˆ¤å®šã™ã‚‹
- Teamsã«Hookã™ã‚‹
- Slackã«Hookã™ã‚‹

ã“ã‚Œã‚‰ã®æµã‚Œã‚’Terraformã¨StepFunctionã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å®šç¾©ã‚’åˆ©ç”¨ã—ã€Teamsã¨Slackã«é€šçŸ¥ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

## AWS S3 to SQS

æœ€çµ‚çš„ã«ã¯S3ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ã—ã¦ã€StepFunctionã‚’èµ·å‹•ã—ã¾ã™ãŒã€å…ˆãšã¯SQSã«ã‚·ã‚°ãƒŠãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã€‚

ã“ã‚Œã¯StepFunctionå¤±æ•—æ™‚ã«å†è©¦è¡Œã™ã‚‹æ™‚ã‚„ã€ãã‚‚ãã‚‚StepFunctionã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆ¶å¾¡ã—ãŸã„ã¨ããªã©ã«SQSã‚’åˆ©ç”¨ã™ã‚‹äº‹ãŒå‡ºæ¥ã‚‹ç‚ºã§ã™ã€‚

```tf

# S3ã‹ã‚‰SQSã«é€šçŸ¥ã‚’é€ã‚‹
resource "aws_s3_bucket_notification" "bucket_notification" {
  bucket = "bucket_name"

  queue {
    queue_arn = aws_sqs_queue.source_queue.arn
    events    = ["s3:ObjectCreated:*"]
  }
}

# S3ã‹ã‚‰å—ã‘å–ã‚‹SQS
resource "aws_sqs_queue" "source_queue" {
  name = "aws_sqs_queue_sample"

  delay_seconds              = 0
  max_message_size           = 262144
  message_retention_seconds  = null
  visibility_timeout_seconds = null
  receive_wait_time_seconds  = null
}

# SQSã‚­ãƒ¥ãƒ¼ã®ãƒãƒªã‚·ãƒ¼è¨­å®š
# Bucket ã‹ã‚‰ã®ã‚·ã‚°ãƒŠãƒ«ã‚’å—ä¿¡å¯èƒ½ã«ã™ã‚‹ãƒãƒªã‚·ãƒ¼
resource "aws_sqs_queue_policy" "source_queue_policy" {
  queue_url = aws_sqs_queue.source_queue.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = {
          Service = "s3.amazonaws.com"
        }
        Action   = "sqs:SendMessage",
        Resource = "${aws_sqs_queue.source_queue.arn}"
        Condition = {
          ArnLike = {
            "aws:SourceArn" = "arn:aws:s3:*:*:bucket_name"
          }
        }
      }
    ]
  })
}

```

`aws_s3_bucket_notification` ã‚’åˆ©ç”¨ã™ã‚‹äº‹ã§ã€S3ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’SQSã‚„Lambdaãªã©ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

## SQS to EventBridge Pipe to StepFunction

SQSã‹ã‚‰ã¯EventBridge Pipeæ©Ÿèƒ½ã‚’çµŒç”±ã—ã¦StepFunctionã‚’èµ·å‹•ã—ã¾ã™ã€‚

SQSã‹ã‚‰ç›´æ¥StepFunctionã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ãƒƒã‚¯å‡ºæ¥ãªã„ç‚ºã€EventBridgeã‚’çµŒç”±ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```tf
# SQS to StepFunction ã®EventBridgePipe
resource "aws_pipes_pipe" "step_function_trigger" {
  name   = "eventbridge_sample"
  source = aws_sqs_queue.source_queue.arn

  source_parameters {
    sqs_queue_parameters {
      batch_size                         = 1
      maximum_batching_window_in_seconds = 0
    }
  }

  # StepFunctionã¯å¾Œè¿°ã—ã¾ã™
  target = aws_sfn_state_machine.processing_workflow.arn 

  target_parameters {
    step_function_state_machine_parameters {
      invocation_type = "FIRE_AND_FORGET"
    }
  }

  role_arn = aws_iam_role.eventbridge_step_function_role.arn
}
```

IAM Roleã€ãƒãƒªã‚·ãƒ¼ã‚’é©åˆ‡ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

```tf
# EventBridgePipe ã‹ã‚‰ Step Function ã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã® IAM ãƒ­ãƒ¼ãƒ«
resource "aws_iam_role" "eventbridge_step_function_role" {
  name = "eventbridge_sample_role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = [
            "pipes.amazonaws.com"
          ]
        }
      }
    ]
  })
}

# EventBridgePipe ã‹ã‚‰ Step Function ã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã® IAM ãƒãƒªã‚·ãƒ¼
resource "aws_iam_role_policy" "eventbridge_step_function_policy" {
  name ="eventbridge_sample_role_policy"
  role = aws_iam_role.eventbridge_step_function_role.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "states:StartExecution"
        ]
        Resource = aws_sfn_state_machine.processing_workflow.arn
      },
      {
        Effect = "Allow"
        Action = [
          "sqs:ReceiveMessage",
          "sqs:DeleteMessage",
          "sqs:GetQueueAttributes"
        ]
        Resource = aws_sqs_queue.source_queue.arn
      },
      {
        Effect = "Allow"
        Action = [
          "logs:CreateLogGroup",
          "logs:CreateLogStream",
          "logs:PutLogEvents"
        ]
        Resource = "arn:aws:logs:*:*:*"
      }
    ]
  })
}
```

StepFunctionã®èµ·å‹•ã€SQSã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ã€CloudWatchã¸ã®ãƒ­ã‚°é€ä¿¡ ã®3ç¨®é¡ã‚’è¨±å¯ã—ã¾ã™ã€‚

## Stepfunction

æœ€å¾Œã«ã€StepFunctionã‚’å®šç¾©ã—ã¾ã™ã€‚
definition ã¯å¾Œã§æ›¸ãã¾ã™ã®ã§ã€ä¸€æ—¦Terraformã§StepFunctionã‚’å®šç¾©ã—ã¦ãŠãã¾ã™ã€‚

```tf
# Step Functionsã®çŠ¶æ…‹ãƒã‚·ãƒ³å®šç¾©
resource "aws_sfn_state_machine" "processing_workflow" {
  name       = "stepfunction_sample"
  role_arn   = aws_iam_role.step_functions_role.arn
  definition = "" # TODO: ã‚ã¨ã§æ›¸ãã¾ã™ã€‚
}

# Step Functionsã®å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã®ä½œæˆ
resource "aws_iam_role" "step_functions_role" {
  name = var.sfn.role_name

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "states.amazonaws.com"
        }
      }
    ]
  })
}
```

## Stepfunction ã§å¤–éƒ¨APIã‚’å©ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹

ã“ã“ã§Teamsã¨Slackã¸ã®é€ä¿¡ã‚’ã™ã‚‹ç‚ºã«ã€HTTP ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æ¥ç¶š EventBridgeã‚’ä½œæˆã—ã¾ã™ã€‚

https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-target-connection.html

![](https://storage.googleapis.com/zenn-user-upload/a79c58b22507-20241102.png)

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã®ã¨ãŠã‚Šã€APIã®å®šç¾©ã¨Event bus, pipeã‚„Connectionã®ä½œæˆã€SecretManagerã‹ã‚‰ã®èªè¨¼æƒ…å ±ã®å–å¾—ã€ãã‚Œã‚‰ã‚’StepFunctionã®HTTP taskã‹ã‚‰å©ãã¨è¨€ã£ãŸå‡¦ç†ã‚’æ›¸ã‹ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

ãã“ã§ã€AWSå…¬å¼ãŒç”¨æ„ã—ã¦ã„ã‚‹EvenBridgeã®Moduleã‚’åˆ©ç”¨ã—ã¦æ‰‹è»½ã«ä¸Šè¨˜è¨­å®šã‚’è¿½åŠ ã—ã¦ã¿ã¾ã™ã€‚

https://registry.terraform.io/modules/terraform-aws-modules/eventbridge/aws/latest

```tf
#
# Teams Notification
#
locals {
  notify_teams_webhook_url    = "https://***"
  notify_teams_webhook_method = "POST"
  notify_teams_webhook_sig    = ""
}

module "eventbridge_with_api_teams_notification" {
  source = "terraform-aws-modules/eventbridge/aws"

  bus_name           = "teams-notify"
  create_connections = true

  connections = {
    teams_notify = {
      authorization_type = "API_KEY"
      auth_parameters = {
        api_key = {
          key   = "Content-Type"
          value = "application/json"
        }
      }
    }
  }
}

#
# Slack Notification
#
locals {
  notify_slack_webhook_url    = "https://***"
  notify_slack_webhook_method = "POST"
}

module "eventbridge_with_api_slack_notification" {
  source = "terraform-aws-modules/eventbridge/aws"

  bus_name           = "slack-notify"
  create_connections = true

  connections = {
    slack_notify = {
      authorization_type = "API_KEY"
      auth_parameters = {
        api_key = {
          key   = "Content-Type"
          value = "application/json"
        }
      }
    }
  }
}
```

ã“ã‚Œã§ã€StepFunction HTTP taskä»¥å¤–ã®éƒ¨åˆ†ãŒè‡ªå‹•ã§ä½œæˆã•ã‚Œã¾ã™ã€‚
ç°¡å˜ã§ã™ã­ã€‚

ã“ã®æµã‚Œã§ã€Slackã¨Teamsã®WebhookURLã‚’å–å¾—ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

- [Teams Webhook URLå–å¾—æ–¹æ³•](https://support.microsoft.com/ja-jp/office/create-incoming-webhooks-with-workflows-for-microsoft-teams-8ae491c7-0394-4861-ba59-055e33f75498)
- [Slack Webhook URLå–å¾—æ–¹æ³•](https://zenn.dev/murakami_koki/articles/7a059ca006b566)

ä¸Šè¨˜ã®ã‚ãŸã‚Šã®è¨˜äº‹ã‚’å‚è€ƒã«ã€URLã‚’å–å¾—ã—ã¾ã™ã€‚


## Stepfuntion - ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å®šç¾©

ã“ã“ãŒä¸€ç•ªé‡è¦ãªéƒ¨åˆ†ã§ã™ãŒã€Slackã¨Teamsã«é€šçŸ¥ã™ã‚‹ãŸã‚ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’å®šç¾©ã—ã¾ã™ã€‚

ã§ã€S3ã«å…¥ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»Šå›ã¯ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ã¨ã„ã†äº‹ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªJsonãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ãã‚‹äº‹ã¨ã—ã¾ã™ã€‚

```json
[
    {
        "code": "error_01",
        "message": "example errors"
    }
]
```

ãã—ã¦ã€ä»¥ä¸‹ã®StepFunctionã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å®šç¾©ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

```json
{
    "StartAt": "S3DataTransfer",
    "States": {
        "S3DataTransfer": {
            "Type": "Pass",
            "Next": "S3FileImport",
            "Parameters": {
                "body.$": "States.StringToJson($)"
            },
            "InputPath": "$[0].body"
        },
        "S3FileImport": {
            "Type": "Map",
            "ItemProcessor": {
                "ProcessorConfig": {
                    "Mode": "DISTRIBUTED",
                    "ExecutionType": "STANDARD"
                },
                "StartAt": "Choice",
                "States": {
                    "Choice": {
                        "Type": "Choice",
                        "Choices": [
                            {
                                "Or": [
                                    {
                                        "Variable": "$.code",
                                        "StringEquals": "error_01"
                                    }
                                ],
                                "Next": "TeamsHook"
                            }
                        ],
                        "Default": "SlackHook"
                    },
                    "TeamsHook": {
                        "Type": "Task",
                        "Resource": "arn:aws:states:::http:invoke",
                        "Parameters": {
                            "Authentication": {
                                "ConnectionArn": "${TeamsWebhookConnectionArn}"
                            },
                            "ApiEndpoint": "${TeamsWebhookEndpoint}",
                            "RequestBody": {
                                "type": "message",
                                "attachments": [
                                    {
                                        "contentType": "application/vnd.microsoft.card.adaptive",
                                        "content": {
                                            "type": "AdaptiveCard",
                                            "body": [
                                                {
                                                    "type": "TextBlock",
                                                    "text": "StepFunctionã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ ç¢ºèªã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚",
                                                    "weight": "bolder",
                                                    "size": "Large"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            },
                            "Method": "${TeamsWebhookMethod}",
                            "QueryParameters": {
                                "api-version": "2016-06-01",
                                "sp": "/triggers/manual/run",
                                "sv": "1.0",
                                "sig": "${TeamsWebhookSig}"
                            }
                        },
                        "ResultPath": null,
                        "Next": "SlackHook"
                    },
                    "SlackHook": {
                        "Type": "Task",
                        "Resource": "arn:aws:states:::http:invoke",
                        "Parameters": {
                            "Authentication": {
                                "ConnectionArn": "${SlackWebhookConnectionArn}"
                            },
                            "ApiEndpoint": "${SlackWebhookEndpoint}",
                            "RequestBody": {
                                "blocks": [
                                    {
                                        "type": "section",
                                        "text": {
                                            "type": "mrkdwn",
                                            "text.$": "States.Format('*Code:*\n {} \n*Message:*\n {} \n ```\n{}\n```', $.code, $.message, States.JsonToString($))"
                                        }
                                    }
                                ]
                            },
                            "Method": "${SlackWebhookMethod}"
                        },
                        "End": true
                    }
                }
            },
            "ItemReader": {
                "Resource": "arn:aws:states:::s3:getObject",
                "ReaderConfig": {
                    "InputType": "JSON"
                },
                "Parameters": {
                    "Bucket.$": "$.body.Records[0].s3.bucket.name",
                    "Key.$": "$.body.Records[0].s3.object.key"
                }
            },
            "MaxConcurrency": 1000,
            "Label": "S3FileImport",
            "End": true,
            "ResultWriter": {
                "Resource": "arn:aws:states:::s3:putObject",
                "Parameters": {
                    "Bucket": "${ErrorLogExportBucketName}",
                    "Prefix": "sfn/error_log/"
                }
            }
        }
    }
}
```

ã“ã®ä¸­ã§ã€`${ErrorLogExportBucketName}` ãªã©ã®å¤‰æ•°ãŒè¨˜å…¥ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«Terraformå†…ã§å¤‰æ•°ã‚’å±•é–‹ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

```tf
definition = templatefile("${path.module}/statemachine/sample.asl.json", {
    ErrorLogExportBucketName = module.s3.arn // ã‚µãƒ³ãƒ—ãƒ«
})
```

ã“ã®ã‚ˆã†ã«ã—ã¦ã€Terraformã§å®šç¾©ã—ãŸæƒ…å ±ã€ç‰¹ã«ARNãªã©ã®æƒ…å ±ã‚’ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å®šç¾©ã«å±•é–‹ã™ã‚‹äº‹ãŒå¯èƒ½ã§ã™ã€‚

ã§ã¯ã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å®šç¾©ä¸Šã§è¡Œã£ã¦ã„ã‚‹äº‹ã‚’è§£èª¬ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

### 1. ãƒ‡ãƒ¼ã‚¿æ•´å½¢

```json
"S3DataTransfer": {
    "Type": "Pass",
    "Next": "S3FileImport",
    "Parameters": {
        "body.$": "States.StringToJson($)"
    },
    "InputPath": "$[0].body"
},
```

ã“ã‚Œã¯ã€S3ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®Bodyã€ã¤ã¾ã‚ŠBucketåã‚„ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ¼åãªã©ãŒå…¥ã£ã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’å–ã‚Šå‡ºã™ä½œæ¥­ã‚’ã—ã¦ã„ã¾ã™ã€‚
bodyã®ä¸­ã«ã¯ã€Jsonã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—åˆ—ãŒå…¥ã£ã¦ãŠã‚Šã€StepFunctionä¸Šã§ãã®ã¾ã¾å±•é–‹ã—ã¦ä½¿ã†ã®ãŒé›£ã—ã„ï¼ˆå‡ºæ¥ã‚‹ãŒã€éƒ½åº¦å¤‰æ›ãŒå¿…è¦ï¼‰ã®ã§ã€
äº‹å‰ã«Jsonãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚

### 2. S3 Get Object to JSON Map

```json
"S3FileImport": {
    "Type": "Map",
    "ItemProcessor": {
        "ProcessorConfig": {
            "Mode": "DISTRIBUTED",
            "ExecutionType": "STANDARD"
        },
        "StartAt": "Choice",
        "States": {} // StateãŒå…¥ã‚‹
    },
    "ItemReader": {
        "Resource": "arn:aws:states:::s3:getObject",
        "ReaderConfig": {
            "InputType": "JSON"
        },
        "Parameters": {
            "Bucket.$": "$.body.Records[0].s3.bucket.name",
            "Key.$": "$.body.Records[0].s3.object.key"
        }
    },
    "MaxConcurrency": 1000,
    "Label": "S3FileImport",
    "End": true
}
```

ã“ã®Stateã¯éå¸¸ã«ä¾¿åˆ©ãªStateã¨ãªã£ã¦ãŠã‚Šã€S3ã‹ã‚‰å–å¾—ã—ãŸJsonãƒ‡ãƒ¼ã‚¿ã‚’å±•é–‹ã—ã¦Mapã¨ã—ã¦ãƒ«ãƒ¼ãƒ—å‡¦ç†ã‚’å›ã™ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

è¦ã¯ã€ã‚³ãƒ«ãƒ¼ãƒãƒ³ã§å›ã›ã‚‹ã¨è¨€ã†ã“ã¨ã§ã™ã­ã€‚

`"ItemReader"` ã«Bucketåã¨Keyåã‚’å±•é–‹ã™ã‚‹ã‚ˆã†ã«æŒ‡å®šã™ã‚Œã°ã€S3ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ã¦ãã‚‹äº‹ãŒå‡ºæ¥ã¾ã™ã€‚

`"States": {} // StateãŒå…¥ã‚‹` Statesã«Mapå‡¦ç†ã‚’è¡Œã†ä¸­èº«ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å®šç¾©ã‚’æ›´ã«è¨˜å…¥ã—ã¾ã™ã€‚

### 2-1. Choice - ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§Teamsã«é€šçŸ¥ã™ã‚‹ã‹ã©ã†ã‹ã‚’åˆ†å²ã™ã‚‹å‡¦ç†

```json
"Choice": {
    "Type": "Choice",
    "Choices": [
        {
            "Or": [
                {
                    "Variable": "$.code",
                    "StringEquals": "error_01"
                }
            ],
            "Next": "TeamsHook"
        }
    ],
    "Default": "SlackHook"
},
```

Mapã®ä¸­èº«ã«ç§»ã‚Šã¾ã™ã€‚
ã“ã®Mapã§ã¯ã‚¨ãƒ©ãƒ¼ã®é…åˆ—å†…éƒ¨ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ¯ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ã“ã“ã®ä¾‹ã§ã¯Teamsã«Webhookã‚’ã™ã‚‹ã‹ã©ã†ã‹ã‚’ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åˆ¤åˆ¥ã—ã¦åˆ†å²ã—ã¦ã„ã¾ã™ã€‚
Defaultã¯Slackã«ã—ã¦ã„ã‚‹ã®ã§ã€è©²å½“ã—ãªã„ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§ã‚ã‚Œã°SlackHookã«æµã‚Œã¾ã™ã€‚

### 2-2. TeamsHook

```json
"TeamsHook": {
    "Type": "Task",
    "Resource": "arn:aws:states:::http:invoke",
    "Parameters": {
        "Authentication": {
            "ConnectionArn": "${TeamsWebhookConnectionArn}"
        },
        "ApiEndpoint": "${TeamsWebhookEndpoint}",
        "RequestBody": {
            "type": "message",
            "attachments": [
                {
                    "contentType": "application/vnd.microsoft.card.adaptive",
                    "content": {
                        "type": "AdaptiveCard",
                        "body": [
                            {
                                "type": "TextBlock",
                                "text": "StepFunctionã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ ç¢ºèªã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚",
                                "weight": "bolder",
                                "size": "Large"
                            }
                        ]
                    }
                }
            ]
        },
        "Method": "${TeamsWebhookMethod}",
        "QueryParameters": {
            "api-version": "2016-06-01",
            "sp": "/triggers/manual/run",
            "sv": "1.0",
            "sig": "${TeamsWebhookSig}"
        }
    },
    "ResultPath": null,
    "Next": "SlackHook"
},
```

ã„ã‚ˆã„ã‚ˆæœ¬é¡Œã§ã™ã€‚

`Parameters.Authentication.ConnectionArn` ã«ã¯ã€å…ˆã»ã©Terraformã§ä½œæˆã—ãŸEventBridgeã®ConnectionArnã‚’è¨˜å…¥ã—ã¾ã™ã€‚

Connectionã§å®šç¾©ã—ãŸåŒã˜APIEndpointã‚’ `"ApiEndpoint": "${TeamsWebhookEndpoint}",` ã«å…¥ã‚Œã€ `RequestBody` ã«Teamså´ã«æŠ•ã’ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚
Teamsã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã¯QueryParamsã«ã‚ˆã‚‹èªè¨¼ã‚‚å…¥ã£ã¦ã„ã‚‹ãŸã‚ã€ç½²åæƒ…å ±ã‚’ `QueryParameters` ã«å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

`"Next": "SlackHook"` ã¨æ›¸ã„ã¦ã‚ã‚‹ã‚ˆã†ã«ã€Teamsã«ã¯é™å®šçš„ãªæƒ…å ±ã‚’ã€Slackã¯ã™ã¹ã¦ã®é€šçŸ¥ã‚’æµã™ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚

### 2-3. SlackHook

```json
"SlackHook": {
    "Type": "Task",
    "Resource": "arn:aws:states:::http:invoke",
    "Parameters": {
        "Authentication": {
            "ConnectionArn": "${SlackWebhookConnectionArn}"
        },
        "ApiEndpoint": "${SlackWebhookEndpoint}",
        "RequestBody": {
            "blocks": [
                {
                    "type": "section",
                    "text": {
                        "type": "mrkdwn",
                        "text.$": "States.Format('*Code:*\n {} \n*Message:*\n {} \n ```\n{}\n```', $.code, $.message, States.JsonToString($))"
                    }
                }
            ]
        },
        "Method": "${SlackWebhookMethod}"
    },
    "End": true
}
```

Slackã‚‚Teamsã¨åŒæ§˜ã«ã€ConnectionArnã¨ApiEndpointã‚’å…¥åŠ›ã—ã€SlackWebhookã«åˆã£ãŸRequestBodyã‚’è¨˜è¼‰ã—ã¾ã™ã€‚
éå¸¸ã«ç°¡å˜ã§ã™ã­ã€‚

ã¡ãªã¿ã«ã€Method ã¯ã©ã¡ã‚‰ã‚‚ `POST` ã§ã™ã€‚

## ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å®šç¾©ã‚’Terraformã§èª­ã¿å–ã‚‹

å°‘ã—å…ˆã ã—ã—ã¦ã—ã¾ã„ã¾ã—ãŸãŒã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ã€StepFunctionã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å®šç¾©ã«è¨˜è¼‰ã—ãŸå¤‰æ•°ã«æƒ…å ±ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚


```tf
resource "aws_sfn_state_machine" "processing_workflow" {
  name       = "stepfunction_sample"
  role_arn   = aws_iam_role.step_functions_role.arn
  definition = templatefile("${path.module}/statemachine/test.asl.json", {
    TeamsWebhookConnectionArn = module.eventbridge_with_api_teams_notification.eventbridge_connections["teams_notify"].arn
    TeamsWebhookEndpoint      = local.notify_teams_webhook_url
    TeamsWebhookMethod        = local.notify_teams_webhook_method
    TeamsWebhookSig           = local.notify_teams_webhook_sig
    SlackWebhookConnectionArn = module.eventbridge_with_api_slack_notification.eventbridge_connections["slack_notify"].arn
    SlackWebhookEndpoint      = local.notify_slack_webhook_url
    SlackWebhookMethod        = local.notify_slack_webhook_method
  })  
}

```

Jsonãƒ‡ãƒ¼ã‚¿ã¯ãã®ã¾ã¾Terrraformã«è¨˜å…¥ã—ã¦ã‚‚è‰¯ã„ã§ã™ãŒã€å¤§ä½“ã®ã‚±ãƒ¼ã‚¹ã§å®šç¾©ãŒè†¨å¤§ã«ãªã£ã¦ã—ã¾ã†ãŸã‚ã€åˆ†ã‘ã¦ã„ãŸæ–¹ãŒè¦‹ã‚„ã™ããªã‚‹ã¨æ€ã„ã¾ã™ã€‚

## ãŠã£ã¨å¿˜ã‚Œã¦ã„ã¾ã—ãŸã€‚IAMã§ã™

IAMã¯éå¸¸ã«é•·ããªã£ã¦ã—ã¾ã†ã®ã§ã€è¦‹ãŸã„æ–¹ã¯å±•é–‹ã—ã¦è¦‹ã¦ãã ã•ã„ã€‚

:::details IAM

```tf
# Step Function IAM Policy - HTTP Endpoint
resource "aws_iam_role_policy" "s3_sfn_policy_endpoint" {
  name   = "s3-sfn-endpoint-policy"
  role   = module.s3.sfn_role_id
  policy = data.aws_iam_policy_document.s3_sfn_endpoint_policy_document.json
}

data "aws_iam_policy_document" "s3_sfn_endpoint_policy_document" {
  statement {
    actions = ["states:InvokeHTTPEndpoint"]
    resources = [
      module.s3.sfn_arn,
      "arn:aws:states:ap-northeast-1:${account_id}:stateMachine:*",
      "arn:aws:states:ap-northeast-1:${account_id}:execution:*"
    ]

    condition {
      test     = "StringEquals"
      variable = "states:HTTPEndpoint"
      values = [
        local.notify_teams_webhook_url,
        local.notify_slack_webhook_url
      ]
    }

    condition {
      test     = "StringEquals"
      variable = "states:HTTPMethod"
      values   = ["POST"]
    }
  }
}

# Step Function IAM Policy - Eventbridge Connection
resource "aws_iam_role_policy" "s3_sfn_policy_connection" {
  name   = "s3-sfn-connection-policy"
  role   = module.s3.sfn_role_id
  policy = data.aws_iam_policy_document.s3_sfn_connection_policy_document.json
}

data "aws_iam_policy_document" "s3_sfn_connection_policy_document" {
  statement {
    actions = ["events:RetrieveConnectionCredentials"]
    resources = [
      module.eventbridge_with_api_teams_notification.eventbridge_connections["teams_notify"].arn,
      module.eventbridge_with_api_slack_notification.eventbridge_connections["slack_notify"].arn,
    ]
  }
  statement {
    actions = [
      "secretsmanager:GetSecretValue",
      "secretsmanager:DescribeSecret"
    ]
    resources = [
      module.eventbridge_with_api_teams_notification.eventbridge_connections["teams_notify"].secret_arn,
      module.eventbridge_with_api_slack_notification.eventbridge_connections["slack_notify"].secret_arn
    ]
  }
}

# Step Function IAM Policy - S3
resource "aws_iam_role_policy" "s3_sfn_policy_s3" {
  name   = s3-sfn-s3-policy"
  role   = module.s3.sfn_role_id
  policy = data.aws_iam_policy_document.s3_sfn_s3_policy_document.json
}

data "aws_iam_policy_document" "s3_sfn_s3_policy_document" {
  statement {
    actions = ["s3:*Object"]
    resources = [
      "${module.s3.bucket_arn}/*"
    ]
  }
}

# Step Function IAM Policy - Execution Map(JSON)

resource "aws_iam_role_policy" "s3_sfn_policy_execution" {
  name   = "s3-sfn-execution-policy"
  role   = module.s3.sfn_role_id
  policy = data.aws_iam_policy_document.s3_sfn_execution_policy_document.json
}

data "aws_iam_policy_document" "s3_sfn_execution_policy_document" {
  statement {
    actions   = ["states:StartExecution"]
    resources = [module.s3.sfn_arn]
  }
}
```

IAMã§ã¯ã€ãã‚Œãã‚Œã®ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦è¨±å¯ã‚’ä¸ãˆã¦ã„ã¾ã™ã€‚S3ã«ã¤ã„ã¦ã¯ä»Šå›ä½œæˆã¾ã§æ›¸ã„ã¦ã„ãªã„ã®ã§ã€
é©å®œbucket arn ãªã©ã‚’å–å¾—ã—å±•é–‹ã—ã¦ãã ã•ã„ã€‚

:::


## Terraform Apply

ã•ã¦ã€é•·ããªã£ãŸå®šç¾©ã¯ã‚³ã‚³ã§çµ‚ã‚ã‚Šã§ã™ã€‚

ã„ã¤ã‚‚é€šã‚Šã®ã‚³ãƒãƒ³ãƒ‰ã‚’å©ãã¾ã™ã€‚

```sh
terraform fmt
terraform init
terraform plan
terraform apply
```

## é€šçŸ¥ã®ç¢ºèª

Jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’S3ã«æŠ•ã’ã¦ã¿ã¾ã™ã€‚

```json
[
    {
        "code": "error_01",
        "message": "äºˆæœŸã›ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
    }
]
```

Slackã®é€šçŸ¥

![](https://storage.googleapis.com/zenn-user-upload/693f8988881b-20241104.png)

Teamsã®é€šçŸ¥

![](https://storage.googleapis.com/zenn-user-upload/3e9622989bfd-20241104.png)

è«¸ã€…å¤‰æ›´ã—ã¦ã„ã‚‹ã®ã§å¤šå°‘ç•°ãªã£ãŸUIã«ãªã£ã¦ã„ã¾ã™ãŒã€ã€ï¼ˆã‚¨ãƒ©ãƒ¼æ–‡ãªã©ã‚’å±•é–‹å‡ºæ¥ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ï¼‰
è‰¯ã„æ„Ÿã˜ã«é€šçŸ¥å‡ºæ¥ã¦ã„ã¾ã™ã­ã€‚

## æœ€å¾Œã«

é•·ä¸å ´ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸãŒã€ã‚„ã£ã¦ã‚‹ã“ã¨ã¨ã—ã¦ã¯ã‹ãªã‚Šå˜ç´”ã§
ä»Šã¾ã§Lambdaã‚’æ›¸ã„ã¦å®Ÿè¡Œã—ãªã‘ã‚Œã°ã„ã‘ãªã‹ã£ãŸãƒ¬ãƒ™ãƒ«ã®ã‚‚ã®ã‚’StepFunctionä¸Šã§å®šç¾©ã™ã‚‹ã“ã¨ã§ç°¡å˜ã«HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ã¨åˆ†ã‹ã‚Šã¾ã—ãŸã€‚

ãŸã¨ãˆã°ã€S3ã«Jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ•ã’ã‚‹ã ã‘ã§ã„ã„ã®ã§ã™ã‹ã‚‰ å„ã‚µãƒ¼ãƒ“ã‚¹ã‚„Lambdaã‹ã‚‰ã‚¨ãƒ©ãƒ¼ã‚’ç™ºå ±ã—ãŸã‚‰Jsonãƒ‡ãƒ¼ã‚¿ã‚’S3ã«ç”Ÿæˆã•ã‚Œã‚‹ã‚ˆã†ã«EventBridgeã‚’æ›¸ã„ãŸã‚Šã€
ãƒ‡ãƒã‚¤ã‚¹ã«Agentã‚’é–‹ç™ºã—ãŸã¨ããªã©ã«ã€ã‚¨ãƒ©ãƒ¼æ™‚ã«S3ã«ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ãŠã„ãŸã‚Šãªã©,, S3ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§å…¨ä½“è²¬å‹™ã¨ã—ã¦é€šçŸ¥éƒ¨åˆ†ã‚’å®Œå…¨åˆ†é›¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

StepFunctionä¸Šã«Teamsã‚„Slackä»¥ä¸Šã«ã€ãã®ä»–ã‚µãƒ¼ãƒ“ã‚¹ãªã©ã®å®šç¾©ã‚’æ›¸ã„ã¦ãŠã‘ã°ã‚ªãƒ³ã‚³ãƒ¼ãƒ«å¯¾å¿œãªã©ã‚‚å®Ÿæ–½å‡ºæ¥ã¾ã™ã€‚

ä»Šå›ã€Terraformã§è¨˜è¼‰ã—ã¾ã—ãŸã®ã§åˆ©ç”¨ã—ã¦ã¿ã¦ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚

ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚