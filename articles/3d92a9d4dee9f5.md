---
title: "Gitlab CI Runner ã‚’helmfileã§æ§‹ç¯‰"
emoji: "ğŸ•Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["k8s", "helm", "helmfile"]
published: false
---

Gitlab Runnerã‚’åˆ©ç”¨ã™ã‚‹éš›ã€Gitlabç¤¾ãŒãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã—ã¦ã„ã‚‹Runnerã‚’åˆ©ç”¨ã—ãŸã‚Šã€è‡ªèº«ã®PCãªã©ã«æ§‹ç¯‰ã™ã‚‹ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆå‹ã®Runnerã‚’åˆ©ç”¨ã™ã‚‹äº‹ãŒå¤šã„ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ã¯è²»ç”¨å‰Šæ¸›ã¨ã„ã†äº‹ã§å¾Œè€…ã®ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆå‹ã®Runnerã‚’k8sã§æ§‹ç¯‰ã—ã¾ã™ã€‚

## Gitlab Runner

https://docs.gitlab.com/runner/install/index.html

æ™®æ®µåˆ©ç”¨ã§ã‚ã‚Œã°ã€ï¼ˆUbuntu Linuxã‚µãƒ¼ãƒã‚’æ§‹ç¯‰ã—ï¼‰

```sh
sudo apt install gitlab-runner
```

ã§è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

ãƒ›ã‚¹ãƒˆç«¯æœ«ã‚’æ±šã—ãŸããªã„å ´åˆã¯

```sh
docker run -d --name gitlab-runner --restart always \
  -v /srv/gitlab-runner/config:/etc/gitlab-runner \
  -v /var/run/docker.sock:/var/run/docker.sock \
  gitlab/gitlab-runner:latest
```

ã“ã¡ã‚‰ã®ã‚ˆã†ã«Dockerã‚’åˆ©ç”¨ã™ã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚

ç§ã‚‚æ™®æ®µã¯Dockerã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

ãŸã ã€å¤§è¦æ¨¡ã«Gitlab Runnerã‚’æ§‹ç¯‰ã™ã‚‹ã¨ãªã‚‹ã¨è² è·åˆ†æ•£ã‚ãŸã‚ŠãŒèª²é¡Œã«ãªã‚Š
ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆ + Dockerã ã¨å°‘ã€…å¿ƒè¨±ãªããªã£ã¦ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

ãã“ã§ç™»å ´ã™ã‚‹ã®ãŒã€ [k8s executor](https://docs.gitlab.com/runner/executors/kubernetes/index.html)ã§ã™ã€‚

## è² è·åˆ†æ•£ã‚’k8s executorã§

k8s executor ã§ã¯ã€Runnerã¨ã—ã¦Jobã®ç”Ÿæˆãªã©ã‚’ç›£è¦–ã™ã‚‹Agentã¨ã€k8s pod ã¨ã—ã¦Jobã‚’å®Ÿè¡Œã™ã‚‹ã‚‚ã®ãŒåˆ¥åˆ¥ã«å­˜åœ¨ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/3f61ba6183e8-20241105.png)

Jobã«ã¤ã„ã¦ã¯ã€Gitlab CIã‹ã‚‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã•ã‚Œãªã„é™ã‚ŠPodã¨ã—ã¦ã¯èµ·å‹•ã•ã‚Œã¾ã›ã‚“ã€‚

ã“ã“ã§ã€PodãŒã©ã‚“ã©ã‚“å¢—ãˆã¦ã„ãã€ã€ã¤ã¾ã‚ŠGitlab CIã®JobãŒå¤§é‡ã«ç”Ÿæˆã•ã‚Œã‚‹ã‚ˆã†ãªçŠ¶æ³ã®éš›ã«ã€k8s å´ã®ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¦Nodeã‚’æ¬¡ã€…ã«ç«‹ã¦ã¦ã„ãã¨è¨€ã£ãŸã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãŒå¯èƒ½ã§ã€ä¸€ã¤ã®Nodeã«é›†ä¸­ã•ã›ãšã«åˆ†æ•£ã—ã¦å‡¦ç†ã™ã‚‹ã“ã¨ã§Gitlab CIä¸Šã®å‡¦ç†é€Ÿåº¦ã®ä½ä¸‹ã‚‚é˜²ãã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

ã¾ãŸã€ã‚¹ã‚±ãƒ¼ãƒ«ã‚¤ãƒ³ã®è¨­å®šã‚’å…¥ã‚Œã¦ãŠãã¨åˆ©ç”¨ã—ãªã„å ´åˆã¯Nodeã‚’èµ·å‹•ã—ãªã„çŠ¶æ…‹ã¨ãªã‚‹ãŸã‚è²»ç”¨ã‚‚æ ¼æ®µã¨æŠ‘ãˆã‚‰ã‚Œã‚‹ã¨ã„ã†è¨³ã§ã™ã€‚

ã‹ã£ã“ã„ã„ã§ã™ã‚ˆã­ã€‚

## Helm Chart

åŸºæœ¬çš„ãªå°å…¥æ–¹æ³•ã«ã¤ã„ã¦ã¯

https://docs.gitlab.com/runner/install/kubernetes.html

ã“ã¡ã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã‚ãŸã—ã¯ Helmfileã§ã®ç®¡ç†ãŒå¥½ããªã®ã§ä»Šå›ã¯Helmfileã§è¨˜è¿°ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

### helmfile.d

helmfileã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å…¬å¼ã®HelmChartRepositoryã¨ã€ãƒªãƒªãƒ¼ã‚¹ã‚’è¨˜å…¥ã—ã¾ã™ã€‚

```yaml
repositories:
  - name: gitlab
    url: https://charts.gitlab.io

releases:
  - name: gitlab-runner
    chart: gitlab/gitlab-runner
    namespace: test-namespace
    values:
      - ../values/gitlab.yaml
    installed: true
```

valuesã«è¨­å®šå†…å®¹ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

### values.yaml

```yaml
runners:
  config: |
    [[runners]]
      [runners.machine]
        MachineOptions = [
          "engine-registry-mirror=https://gcr.mirror.io"
        ]
      [runners.kubernetes]
        image = "ubuntu:22.04"
        cpu_request = "500m"
        cpu_request_overwrite_max_allowed = "2000m"
      [runners.feature_flags]
        FF_USE_FASTZIP = true

imagePullPolicy: IfNotPresent

runnerToken: "" # Token
gitlabUrl: "" # Gitlabæœ¬ä½“ã‚’ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆã—ã¦ã„ã‚‹å ´åˆã¯ãã®URL
rbac:
  create: true
  generatedServiceAccountName: "gitlab-ci-runner-sa"
  serviceAccountName: "gitlab-ci-runner-sa"
  rules: 
  - resources: ["events"]
    verbs: ["list", "watch"]
  - resources: ["namespaces"]
    verbs: ["create", "delete"]
  - resources: ["pods"]
    verbs: ["create","delete","get"]
  - apiGroups: [""]
    resources: ["pods/attach","pods/exec"]
    verbs: ["get","create","patch","delete"]
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get","list"]
  - resources: ["secrets"]
    verbs: ["create","delete","get","update"]
  - resources: ["serviceaccounts"]
    verbs: ["get"]
  - resources: ["services"]
    verbs: ["create","get"]
  podSecurityPolicy:
    enabled: true
    resourceNames:
      - gitlab-runner

concurrent: 2

envVars:
  - name: KANIKO_REGISTRY_MIRROR
    value: https://gcr.mirror.io

topologySpreadConstraints:
  - &topologySpreadConstraint
    maxSkew: 1
    topologyKey: kubernetes.io/hostname
    whenUnsatisfiable: DoNotSchedule # ScheduleAnyway or DoNotSchedule
    labelSelector:
      matchLabels:
        app: gitlab-runner
  - <<: *topologySpreadConstraint
    topologyKey: topology.kubernetes.io/zone
  - <<: *topologySpreadConstraint
    topologyKey: topology.kubernetes.io/region

replicas: 3

resources:
  limits:
    memory: 128Mi
    cpu: 4
    ephemeral-storage: 512Mi
  requests:
    memory: 64Mi
    cpu: 100m
    ephemeral-storage: 256Mi

## Configure the livenessProbe
livenessProbe: 
  initialDelaySeconds: 20
  periodSeconds: 10
  successThreshold: 1
  failureThreshold: 3
  terminationGracePeriodSeconds: 30

## Configure the readinessProbe
readinessProbe: 
  initialDelaySeconds: 20
  periodSeconds: 10
  successThreshold: 1
  failureThreshold: 3

```

è«¸ã€…è¨˜è¼‰ã—ã¦ã„ã¾ã™ã®ã§è»½ãè§£èª¬ã‚’ã—ã¾ã™ãŒã€åŸºæœ¬ã¯ `runners` é …ç›®ã®éƒ¨åˆ†ã¨ServiceAccountã‚ãŸã‚Šã ã‘ã§å‹•ãã¨ã¯æ€ã†ã®ã§ã€
ä»–ã®è¨­å®šé …ç›®ã«ã¤ã„ã¦ã¯ä»»æ„ã§è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚

#### runners

Gitlabã®Runnerè¨­å®šã‚’è¨˜å…¥ã—ã¾ã™ã€‚
ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®è¨­å®šé …ç›®ã§ã™ã€‚

```
cpu_request = "500m"
cpu_request_overwrite_max_allowed = "2000m"
```

ã“ã“ã§ã¯k8sã®CPURequestã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ500mã¨ã—ã€MAXã§2ã‚’è¨­å®šå‡ºæ¥ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
CPUã‚³ã‚¢æ•°ãŒ2ã®å ´åˆã€1jobã«å¯¾ã—ã¦1NodeãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ãƒªãƒƒãƒãªçŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

100ã«ã™ã‚Œã°20jobã§ã™ã­ã€‚ 

ã“ã“ã®è¨­å®šå€¤ã‚’å¤‰æ›´ã™ã‚‹äº‹ã§ã€CIã®é€Ÿåº¦ä½ä¸‹ã¨Nodeèµ·å‹•ã«ãŠã‘ã‚‹è²»ç”¨ãªã©ã®èª¿æ•´ãŒå‡ºæ¥ã¾ã™ã€‚


#### rbac

Gitlab k8s Executorã¯æ–°ã—ã„Jobã‚’ç”Ÿæˆã™ã‚‹é–¢ä¿‚ä¸Šã€RBACã«ã‚ˆã‚‹k8sã®Jobä½œæˆãŒå‡ºæ¥ã‚‹æ¨©é™ã‚’Podã«ãŸã„ã—ã¦ä»˜ä¸ã—ã¦ä¸Šã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã‚’å…¥ã‚Œã‚‹äº‹ã§ã€Executorã¯æ–°ã—ã„Jobã‚’ç”Ÿæˆå‡ºæ¥ã‚‹ã¨è¨€ã†ã“ã¨ãªã®ã§ã€å¿…è¦ãªæ¨©é™ã‚’æ¸¡ã—ã¦ãã ã•ã„ã€‚

ï¼ˆã‚µãƒ³ãƒ—ãƒ«ã¯éå‰°ã«æ¨©é™ã‚’æ¸¡ã—ã¦ã„ã‚‹ã®ã§ã€é©å®œçµã£ã¦ãã ã•ã„ï¼‰

#### topologySpreadConstraints

ã“ã‚Œã¯è¦ã‚‰ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
Executoræœ¬ä½“ãŒè¤‡æ•°ã®Nodeã‚„AZã«å‡ç­‰ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã—ã¦ãã‚Œã‚‹è¨­å®šã§ã™ã€‚

APIã‚µãƒ¼ãƒãªã©ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã¯å¿…é ˆã§å…¥ã‚Œã¦ãŠã‹ãªã„ã¨ã€NodeãŒçµ‚äº†ã—ã¦ã—ã¾ã£ãŸéš›ã«ã¾ã¨ã‚ã¦PodãŒè½ã¡ã¦ã—ã¾ã„åœæ­¢æ™‚é–“ãŒç”Ÿã¾ã‚Œã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚


#### resources

ã“ã‚Œã¯k8såŸºæœ¬ã®è¨­å®šé …ç›®ã§ã™ã€‚

CPUã‚„ãƒ¡ãƒ¢ãƒªã®Requestï¼ˆã‚¹ã‚±ãƒ¼ãƒ«ã«èµ·å› ã™ã‚‹è¨­å®šå€¤ï¼‰ã¨Limitï¼ˆè¶…éã™ã‚‹ã¨NodeãŒçµ‚äº†ã™ã‚‹ãªã©ã®å®‰å…¨è£…ç½®ï¼‰ã‚’è¨­å®šå‡ºæ¥ã¾ã™ã€‚

ãŠå¥½ã¿ã§è¨­å®šã™ã‚Œã°ã‚ˆã„ã§ã™ãŒã€Nodeã®CPUã‚³ã‚¢æ•°ãŒå›ºå®šã®å ´åˆã¯ã€Limitå€¤ã‚’MaxCPUã®å€¤ã«è¨­å®šã—ã¦ãŠãã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

CPUã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ã«ãŠã‘ã‚‹æ€§èƒ½ä½ä¸‹å‚è€ƒè³‡æ–™: https://sysdig.jp/blog/troubleshoot-kubernetes-oom/

#### probeç³»

ã“ã‚Œã‚‚k8såŸºæœ¬ã®ã‚‚ã®ã§ã™ã€‚

Podã‚’èµ·å‹•ã—ã¦ã‹ã‚‰HealthCheckã‚’å©ãã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚„ã€ãã®é–“éš”ãªã©ã€ã€
k8såˆ©ç”¨è€…ã§ã‚ã‚Œã°æ™®æ®µåˆ©ç”¨ã—ã¦ã„ã‚‹ã‚‚ã®ã ã¨æ€ã„ã¾ã™ã®ã§é©å®œè¨­å®šãã ã•ã„ã€‚


## å®Ÿè¡Œ

```
helmfile diff
helmfile apply
```

ã“ã‚Œã§RunnerãŒæ§‹ç¯‰ã•ã‚Œã¾ã™ã€‚

## ã•ã„ã”ã«

helmfileã€helm chart ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€ç°¡å˜ã«Runnerã‚’æ§‹ç¯‰å‡ºæ¥ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸã€‚
ã¾ãŸã€k8sã«è¼‰ã›ã‚‹ã“ã¨ã§è†¨å¤§ãªè¦æ¨¡ã®RunnerãŒå¿…è¦ã«ãªã£ã¦ã‚‚k8så´ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã«å¿œã˜ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã—ã¦ãã‚Œã‚‹ã¨ã„ã†çŠ¶æ…‹ã«ãªã‚Šã€
é–‹ç™ºåŠ¹ç‡ã‚‚é£›èºçš„å‘ä¸Šã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ã¨æ€ã„ã¾ã™ã€‚

CIã®é€Ÿåº¦ã¯é–‹ç™ºè€…ã«ã¨ã£ã¦ã®åŠ¹ç‡ã¨ã—ã¦æ­»æ´»å•é¡Œã«ãªã‚Šã‹ã­ãªã„ã®ã§ã€å¤§åˆ‡ã«ã—ã¦ã„ããŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

